<!doctype html><html lang=vi dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM | The Financial Engineer</title>
<meta name=keywords content><meta name=description content="Sá»­ dá»¥ng LLM Ä‘á»ƒ tá»‘i Æ°u danh má»¥c Ä‘áº§u tÆ°"><meta name=author content><link rel=canonical href=http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=vi href=http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous referrerpolicy=no-referrer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BEV31LZP2J"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BEV31LZP2J")}</script><meta property="og:title" content="Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM"><meta property="og:description" content="Sá»­ dá»¥ng LLM Ä‘á»ƒ tá»‘i Æ°u danh má»¥c Ä‘áº§u tÆ°"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-03T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM"><meta name=twitter:description content="Sá»­ dá»¥ng LLM Ä‘á»ƒ tá»‘i Æ°u danh má»¥c Ä‘áº§u tÆ°"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM","item":"http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM","name":"Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM","description":"Sá»­ dá»¥ng LLM Ä‘á»ƒ tá»‘i Æ°u danh má»¥c Ä‘áº§u tÆ°","keywords":[],"articleBody":" BÃ i viáº¿t nÃ y thá»­ nghiá»‡m tá»‘i Æ°u hoÃ¡ danh má»¥c sá»­ dá»¥ng Large Language Model (LLM). ThÆ° viá»‡n langchain vÃ  OpenAI gpt4o vÃ  4o-mini sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng cho thá»­ nghiá»‡m.\nConcept Tá»‘i Æ°u hoÃ¡ danh má»¥c Tá»‘i Æ°u hÃ³a danh má»¥c Ä‘áº§u tÆ° lÃ  quÃ¡ trÃ¬nh phÃ¢n bá»• tÃ i sáº£n vÃ o cÃ¡c khoáº£n Ä‘áº§u tÆ° khÃ¡c nhau nháº±m Ä‘áº¡t Ä‘Æ°á»£c sá»± cÃ¢n báº±ng tá»‘i Æ°u giá»¯a lá»£i nhuáº­n ká»³ vá»ng vÃ  rá»§i ro. CÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a truyá»n thá»‘ng, nhÆ° Modern Portfolio Theory hay Mean-variance optimization, chá»§ yáº¿u dá»±a vÃ o dá»¯ liá»‡u lá»‹ch sá»­ vÃ  cÃ¡c giáº£ Ä‘á»‹nh vá» phÃ¢n phá»‘i lá»£i nhuáº­n. Tuy nhiÃªn, chÃºng cÃ³ má»™t sá»‘ háº¡n cháº¿:\nKhÃ³ khÄƒn trong viá»‡c tÃ­ch há»£p cÃ¡c yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh: CÃ¡c phÆ°Æ¡ng phÃ¡p nÃ y thÆ°á»ng khÃ´ng xem xÃ©t cÃ¡c yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh nhÆ° tin tá»©c thá»‹ trÆ°á»ng, sá»± kiá»‡n kinh táº¿ hoáº·c quan Ä‘iá»ƒm cá»§a chuyÃªn gia, tiá»m nÄƒng tá»« cÃ¢u chuyá»‡n kinh doanh dáº«n Ä‘áº¿n viá»‡c thiáº¿u linh hoáº¡t trong pháº£n á»©ng vá»›i cÃ¡c biáº¿n Ä‘á»™ng thá»‹ trÆ°á»ng. Giáº£ Ä‘á»‹nh Ä‘Æ¡n giáº£n hÃ³a: Viá»‡c giáº£ Ä‘á»‹nh ráº±ng lá»£i nhuáº­n tuÃ¢n theo phÃ¢n phá»‘i chuáº©n vÃ  má»‘i quan há»‡ giá»¯a cÃ¡c tÃ i sáº£n lÃ  tuyáº¿n tÃ­nh cÃ³ thá»ƒ khÃ´ng pháº£n Ã¡nh chÃ­nh xÃ¡c thá»±c táº¿ phá»©c táº¡p cá»§a thá»‹ trÆ°á»ng. LLM lÃ  gÃ¬? MÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (LLM) lÃ  cÃ¡c mÃ´ hÃ¬nh há»c sÃ¢u Ä‘Æ°á»£c huáº¥n luyá»‡n trÃªn khá»‘i lÆ°á»£ng dá»¯ liá»‡u vÄƒn báº£n khá»•ng lá»“, giÃºp chÃºng cÃ³ kháº£ nÄƒng hiá»ƒu vÃ  táº¡o ra ngÃ´n ngá»¯ tá»± nhiÃªn. Vá»›i kháº£ nÄƒng Ä‘á»c hiá»ƒu ngÃ´n ngá»¯ nÃ y, LLM cÃ³ thá»ƒ trÃ­ch xuáº¥t thÃ´ng tin vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u phi cáº¥u trÃºc nhanh chÃ³ng vÃ  Ä‘Æ¡n giáº£n hÆ¡n nhiá»u so vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng. VÃ­ dá»¥, LLM cÃ³ thá»ƒ Ä‘á»c 10 bÃ i bÃ¡o gáº§n Ä‘Ã¢y vÃ  tá»•ng há»£p ra 3 luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° phá»• biáº¿n nháº¥t tá»« cÃ¡c bÃ i bÃ¡o Ä‘Ã³â€”má»™t nhiá»‡m vá»¥ mÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng khÃ³ thá»±c hiá»‡n Ä‘Æ°á»£c.\nTáº£n máº¡n: má»™t cÃ¡ch khoa há»c mÃ  nÃ³i, chÃºng ta cÃ³ thá»ƒ â€œhÃ¬nh dungâ€ LLM nhÆ° sau: LLM lÃ  má»™t cá»— mÃ¡y Ä‘Æ°a ra káº¿t quáº£ dá»±a trÃªn trÆ°á»ng há»£p cÃ³ xÃ¡c suáº¥t cao nháº¥t. CÃ¡c cÃ¢u prompt Ä‘Ã³ng vai trÃ² giá»›i háº¡n pháº¡m vi lá»±a chá»n cá»§a LLM, tá»« Ä‘Ã³ tÄƒng xÃ¡c suáº¥t cho káº¿t quáº£ mong muá»‘n.\nLLM cho tá»‘i Æ°u hoÃ¡ danh má»¥c Vá»›i kháº£ nÄƒng phÃ¢n tÃ­ch vÃ  táº­n dá»¥ng cÃ¡c dá»¯ liá»‡u phi cáº¥u trÃºc trÃªn, LLM lÃ  má»™t á»©ng cá»­ viÃªn sÃ¡ng giÃ¡ cho quÃ¡ trÃ¬nh tá»‘i Æ°u hoÃ¡ danh má»¥c khi cÃ³ thá»ƒ táº­n dá»¥ng Ä‘Æ°á»£c: (1) dá»¯ liá»‡u cÃ³ cáº¥u trÃºc, thá»‘ng kÃª lá»£i nhuáº­n rá»§i ro; (2) dá»¯ liá»‡u phi cáº¥u trÃºc nhÆ° tiá»m nÄƒng tÄƒng trÆ°á»Ÿng cÃ´ng ty, â€¦; (3) Ä‘Ã¡p á»©ng Ä‘Æ°á»£c cÃ¡c yÃªu cáº§u vá» má»¥c tiÃªu Ä‘áº§u tÆ° (objective), hay cÃ¡c ráº±ng buá»™c Ä‘i kÃ¨m (constraints) má»™t cÃ¡c nhanh chÃ³ng.\nÄá»ƒ dá»… dÃ ng hÃ¬nh dung, chÃºng ta sáº½ cÃ¹ng nhau Ä‘i qua thá»­ nghiá»‡m thá»±c táº¿ cho 6 cá»• phiáº¿u FPT, HPG, MWG, REE, VCB vÃ  VNM!\nXÃ¢y dá»±ng danh má»¥c Ä‘áº§u tÆ° sá»­ dá»¥ng LLM Quy trÃ¬nh tá»‘i Æ°u sáº½ nhau sau\nB1: XÃ¡c Ä‘á»‹nh rá»• cá»• phiáº¿u Ä‘áº§u tÆ° B2: Thu tháº­p thÃ´ng tin: (1) Sentiment cá»§a cá»• phiáº¿u; (2) CÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° - rá»§i ro cá»§a cá»• phiáº¿u; (3) tÃ­n hiá»‡u kÄ© thuáº­t; (4) Äá»™ tÆ°Æ¡ng quan giá»¯a cÃ¡c cá»• phiáº¿u vá»›i nhau B3: Tá»‘i Æ°u hoÃ¡ danh má»¥c: (1) CÃ¡c má»¥c tiÃªu Ä‘áº§u tÆ° cÅ©ng nhÆ° giá»›i háº¡n cho phÃ©p; (2) Xem xÃ©t danh má»¥c quÃ¡ khá»© vÃ  hiá»‡u suáº¥t quÃ½ gáº§n nháº¥t. B4: Backtest Thu tháº­p tin tá»©c tá»« google Táº¡i bÆ°á»›c Ä‘áº§u tiÃªn, chÃºng ta cáº§n xÃ¢y dá»±ng má»™t pipeline Ä‘á»ƒ thu tháº­p Ä‘Æ°á»£c cÃ¡c tin tá»©c liÃªn quan Ä‘áº¿n tá»«ng cá»• phiáº¿u, vÃ  pháº£i phÃ¹ há»£p vá»›i thá»i gian cá»§a giai Ä‘oáº¡n backtest. Táº¡i khÃ¢u nÃ y, chÃºng ta sáº½ sá»­ dá»¥ng thÆ° viá»‡n langchain Ä‘á»ƒ xÃ¢y dá»±ng pipeline vÃ  mÃ´ hÃ¬nh gpt-4o-mini Ä‘á»ƒ xá»­ lÃ½ tin tá»©c\n1 2 3 4 5 6 7 8 9 10 11 def load_google_news_before(query: str, before_date: datetime.date, num_results: int = 30): \"\"\" Query Google News via LangChainâ€™s Google Serper API Wrapper, filtering articles so that only those published before the given date are returned. \"\"\" cd_min = convert_date_to_str(before_date - datetime.timedelta(days=90)) cd_max = convert_date_to_str(before_date) tbs = f\"cdr:1,cd_min:{cd_min},cd_max:{cd_max}\" search = GoogleSerperAPIWrapper(type=\"news\", tbs=tbs, gl=\"vn\",hl='vi',k=num_results) results = search.results(query) return results Ta cÃ³ thá»ƒ dá»… dÃ ng táº¡o ra má»™t hÃ m Ä‘á»c tin tá»©c sá»­ dá»¥ng Serper vÃ  thÆ° viá»‡n langchain. HÃ m trÃªn thiáº¿t káº¿ Ä‘á»ƒ láº¥y cÃ¡c tin tá»©c trong vÃ o 90 ngÃ y trÆ°á»›c ngÃ y truyá»n vÃ o.\nTrÃ­ch xuáº¥t cÃ¡c thÃ´ng tin mong muá»‘n Äá»ƒ thu tháº­p thÃ´ng tin phá»¥c vá»¥ Ä‘áº§u tÆ°, ta tÃ¬m kiáº¿m cÃ¡c bÃ i bÃ¡o vá»›i tá»« khÃ³a â€œÄ‘áº§u tÆ° vÃ o cá»• phiáº¿u ABCâ€, trong Ä‘Ã³ ABC lÃ  mÃ£ cá»• phiáº¿u cáº§n phÃ¢n tÃ­ch.\nSau khi cÃ³ Ä‘Æ°á»£c cÃ¡c bÃ i bÃ¡o liÃªn quan, ta thu tháº­p cÃ¡c thÃ´ng tin quan trá»ng bao gá»“m: (1) sentiment cá»§a cá»• phiáº¿u trong quÃ½ vá»«a qua; (2) lÃ½ giáº£i cho káº¿t quáº£ sentiment Ä‘Ã³; (3) cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° (Catalyst); (4) cÃ¡c yáº¿u tá»‘ rá»§i ro.\nÄá»ƒ thá»±c hiá»‡n viá»‡c nÃ y, ta thiáº¿t káº¿ cÃ¢u prompt dá»±a trÃªn cÃ¡c yÃªu cáº§u trÃªn vÃ  sá»­ dá»¥ng mÃ´ hÃ¬nh LLM gpt-4o-mini. VÃ¬ nhiá»‡m vá»¥ nÃ y chá»§ yáº¿u lÃ  tá»•ng há»£p thÃ´ng tin, khÃ´ng Ä‘Ã²i há»i nhiá»u suy luáº­n phá»©c táº¡p, nÃªn viá»‡c sá»­ dá»¥ng má»™t mÃ´ hÃ¬nh nhá» gá»n, nhanh vÃ  tiáº¿t kiá»‡m nhÆ° gpt-4o-mini lÃ  lá»±a chá»n phÃ¹ há»£p.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ## Sá»­ dá»¥ng pydantic Ä‘á»ƒ Ã©p model tráº£ vá» dáº¡ng dá»¯ liá»‡u nhÆ° mong muá»‘n class Sentiment(BaseModel): sentiment: str = Field(default=None, description=\"The financial market sentiment of all news\", enum=[\"bearish\", \"bullish\", \"neutral\"]) explanation: str = Field(default=None, description=\"The short explanation about the chosen sentiment \") catalyst: List[str] = Field(default=None, description=\"The catalyst based on all news\") risk_factor: List[str] = Field(default=None, description=\"The risk factor based on all news\") def extract_key_info(stock , date): \"\"\" Extract key information from a news article. \"\"\" nest_asyncio.apply() query = f\"Ä‘áº§u tÆ° cá»• phiáº¿u {stock}\" # For example, retrieve articles published before January 1, 2025. cutoff_date = date articles = load_google_news_before(query, cutoff_date, num_results=15) links = pd.DataFrame(articles['news'])['link'].to_list() ## drop the link from https://etime.danviet.vn links = [link for link in links if 'danviet.vn' not in link] ## skip for danviet.vn as it block the request loader = WebBaseLoader(links, continue_on_failure=True) loader.requests_per_second = 0.5 docs = loader.aload() ls = [] for doc in docs: ls.append(doc.page_content.replace('\\n\\n', '').replace('\\n', ' ')) llm = ChatOpenAI(model='gpt-4o-mini') prompt = \"\"\" You're a senior analyst. You are analyzing stock {stock} Your tasks are: - Analyze the sentiment of the given news - Explain the sentiment in few words - Identify the key catalysts or drivers - Identify the risk factors {document} Requirement - Be specific and concise - Do not make up information or make assumption - Do not use external source \"\"\".format(stock = stock,document=ls) response = llm.with_structured_output(Sentiment).invoke(prompt) return response date = datetime.date(2024, 1, 1) extract_key_info('HPG', date) Káº¿t quáº£ cá»§a hÃ m trÃªn sáº½ nhÆ° sau:\nSentiment(sentiment=â€˜bearishâ€™, explanation=â€˜Sentiment is bearish due to significant losses reported by HPG and related companies, along with ongoing challenges in the steel market.â€™, catalyst=[â€˜Increased production and sales in October 2023â€™, â€˜Expected recovery in demand and prices for steelâ€™, â€˜Completion of Dung Quáº¥t 2 project may increase capacityâ€™], risk_factor=[â€˜High competition in the steel industryâ€™, â€˜Dependence on domestic market recoveryâ€™, â€˜Fluctuations in raw material pricesâ€™])\nTá»‘i Æ°u hoÃ¡ danh má»¥c Khi tá»‘i Æ°u hoÃ¡ danh má»¥c, viá»‡c xÃ¢y dá»±ng cÃ¢u prompt chi tiáº¿t vÃ  cá»¥ thá»ƒ sáº½ giÃºp giáº£m thiá»ƒu lá»—i vÃ  táº¡o ra tá»· trá»ng há»£p lÃ½ hÆ¡n. Do Ä‘á»™ phá»©c táº¡p táº¡i khÃ¢u nÃ y tÄƒng cao, chÃºng ta cáº§n sá»­ dá»¥ng má»™t mÃ´ hÃ¬nh LLM máº¡nh máº½ hÆ¡n. BÃ i viáº¿t chá»n sá»­ dá»¥ng gpt-4o.\nMá»¥c tiÃªu Ä‘áº§u tÆ°: PhÃ¢n bá»• tá»· trá»ng cho cÃ¡c cá»• phiáº¿u cÃ³ tiá»m nÄƒng tÄƒng trÆ°á»Ÿng cao, dá»±a trÃªn tÃ­n hiá»‡u ká»¹ thuáº­t, sentiment vÃ  cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ°.\nCÃ¡c ráº±ng buá»™c:\nLong-only portfolio KhÃ´ng sá»­ dá»¥ng margin Hold trong 3 thÃ¡ng KhÃ´ng cáº§n Ä‘áº§u tÆ° háº¿t 6 cá»• phiáº¿u nhÆ°ng pháº£i cÃ³ Ã­t nháº¥t 4 cá»• phiáº¿u NgoÃ i ra, cÃ¢u prompt cÅ©ng bao gá»“m má»™t workflow (quy trÃ¬nh) Ä‘á»ƒ LLM cÃ³ thá»ƒ dá»±a vÃ o Ä‘Ã³ Ä‘á»ƒ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh phÃ¢n bá»• tá»· trá»ng\nDá»±a trÃªn cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c cá»• phiáº¿u tiá»m nÄƒng ÄÃ¡nh giÃ¡ sentiment cá»§a cÃ¡c cá»• phiáº¿u Ä‘Ã£ chá»n Sá»­ dá»¥ng tÃ­n hiá»‡u ká»¹ thuáº­t Ä‘á»ƒ xÃ¡c nháº­n thÃªm tiá»m nÄƒng cá»§a cÃ¡c cá»• phiáº¿u Cuá»‘i cÃ¹ng, sá»­ dá»¥ng dá»¯ liá»‡u rá»§i ro-lá»£i nhuáº­n cá»§a 3 thÃ¡ng qua Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c cá»• phiáº¿u Ä‘Æ°á»£c mua quÃ¡ má»©c hoáº·c bá»‹ thá»•i phá»“ng, trÃ¡nh phÃ¢n bá»• quÃ¡ nhiá»u vá»‘n cho chÃºng. Tuy nhiÃªn, náº¿u luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° há»©a háº¹n, ta váº«n cÃ³ thá»ƒ phÃ¢n bá»• tiá»n cho cá»• phiáº¿u Ä‘Ã³ náº¿u tin ráº±ng nÃ³ cÃ³ tiá»m nÄƒng Ä‘Ã¡ng ká»ƒ Chia tá»· trá»ng cho tá»«ng cá»• phiáº¿u dá»±a trÃªn tiá»m nÄƒng cá»§a cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° PhÃ¢n bá»• nhiá»u tá»· trá»ng hÆ¡n cho cÃ¡c cá»• phiáº¿u cÃ³ luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° kháº£ thi vÃ  tiá»m nÄƒng cao 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 prompt = \"\"\" Create a portfolio with the following stocks: {stocks} Objective: - Use the technical signal, market sentiment and catalysts to assign weight to each stock for a long-only portfolio - The portfolio aim to invest in the stock with the highest potential return Constraints: - The portfolio should be well diversified - You can invest in each stock with a maximum of 0.5 of the portfolio - You do not need to invest in all stocks, but you must invest in at least 4 stocks. Only select the most promising stocks. - There is no leverage \u0026 short selling - The holding period is 3 months (1 quarter) - The weight should be a float number between 0 and 1 - The sum of all weights should be 1 Workflow: 1. Analyze information first. 2. Based on the catalysts, identify the stocks that are likely to perform well. 3. Assess the sentiment of the news to confirm the potential of the selected stocks. 4. Use the technical signal to further confirm the potential of the stocks. 5. Finally, use the past 3 months' risk-return data to identify overbought or hyped stocks to avoid allocating too much capital to them. However, if the catalyst is highly promising, you may still allocate funds to it if you believe it has significant potential. 6. Assign weights to each stock based on the potential return driven by the catalyst. 7. Allocate more weight to stocks where the catalyst is more likely to occur and has a higher magnitude. 8. Be confident in assigning higher weights to stocks with better catalysts and sentiment. 9. **Think carefully; do not simply split the weights equally.** Technical signal: simple EMA50-200 crossover, 1 for bullish, 0 for bearish {ta_signal} Past 3 risk return {risk_return} News sentiment (0 for bearish, 1 for bullish, 2 for neutral) \u0026 Catalysts {sentiment} Correlation between stocks {correlation} Your previous portfolio {past_portfolios} Your previous return: {last_period_return} Output - A list with weight for every stock. The weight must correspond to the oder {stocks}. For stock that not invest, simple return 0 for the weight - A detailed explanation of the rationale behind the portfolio allocation \"\"\" Sau Ä‘Ã³, ta sáº½ tÃ­nh toÃ¡n cÃ¡c tham sá»‘ vÃ  Ä‘Æ°a cÃ¡c thÃ´ng tin cáº§n thiáº¿t vÃ o trong mÃ´ hÃ¬nh Ä‘á»ƒ mÃ´ hÃ¬nh thá»±c hiá»‡n vÃ  tÃ­nh toÃ¡n.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 class PortfolioOptimizationResult(BaseModel): \"\"\" A class to represent the result of portfolio optimization. \"\"\" stock_weight: List[float] = Field( default=None, description=\"A list containing the weight for all stocks in the portfolio.\" ) explanation: str = Field( default=None, description=\"A detailed explanation of the rationale behind the portfolio allocation.\" ) def llm_optimizer(date, stocks = ['FPT', 'HPG', 'MWG', 'REE', 'VCB', 'VNM'], past_portfolios = None, last_period_return = None): results = run_in_parallel(stocks, date) llm = ChatOpenAI(model='gpt-4o') ta_signal = ta_compare[:date].iloc[-1] start_sample = date - datetime.timedelta(days=30*3) ## 3 months sample_rets = rets[start_sample:date] risk_return = ((1+sample_rets).product()-1).to_frame() risk_return.columns = ['past_3m_rets'] risk_return['past_3m_volatility'] = sample_rets.std() risk_return['past_3m_sharpe_ratio'] = sample_rets.mean()/risk_return['past_3m_volatility'] risk_return = risk_return.round(4) correlation = sample_rets.corr().round(4) chatprompt = prompt.format(ta_signal=ta_signal, sentiment=results, risk_return=risk_return, stocks=stocks, correlation=correlation, past_portfolios=past_portfolios, last_period_return=last_period_return) optimizer = llm.with_structured_output(PortfolioOptimizationResult).invoke(chatprompt) weight = pd.DataFrame(optimizer.stock_weight, index=stocks, columns=['weights']) weight = weight/weight.sum() ## make sure the sum of weight is 1 retionale = optimizer.explanation return weight, retionale weight, expla = llm_optimizer(datetime.date(2024, 6, 1)) ## this takes around 35 seconds Sau khi cháº¡y hÃ m trÃªn, ta sáº½ nháº­n Ä‘Æ°á»£c káº¿t quáº£ nhÆ° sau (danh má»¥c cho thÃ¡ng 6.2024):\nTá»· trá»ng danh má»¥c\nweights FPT 0.25 HPG 0.2 MWG 0.3 REE 0.15 VCB 0.1 VNM 0.0 LÃ½ do cho tá»· trá»ng trÃªn\nğŸ’¡ In constructing this portfolio, we focused on stocks with strong bullish technical signals and favorable market sentiment, while considering catalysts and risks.\nFPT (Weight: 0.25): FPT has a bullish technical signal, strong sentiment driven by its partnership with NVIDIA for AI development, and projected revenue growth. Although its valuation is high, its catalysts are promising, warranting a significant allocation. HPG (Weight: 0.2): HPG also exhibits a bullish technical signal and optimistic market sentiment due to strong Q1 financial results and upcoming projects like Dung Quáº¥t 2. Despite high debt levels, its growth potential justifies a substantial allocation. MWG (Weight: 0.3): MWG has demonstrated strong past returns and a bullish sentiment, supported by strategic investments and projected growth. The high weight reflects its potential for recovery and profit, despite some risks. REE (Weight: 0.15): REEâ€™s neutral sentiment and mixed outlook are balanced by its dividend plans and growth in renewable energy. Its lower weight reflects these uncertainties, but its diversification benefits and potential in energy justify inclusion. VCB (Weight: 0.1): Despite a neutral sentiment and recent negative returns, VCBâ€™s catalysts such as planned capital increases and potential equity sales offer upside potential, meriting a smaller allocation. VNM (Weight: 0): VNM is excluded due to bearish sentiment and negative past performance, with significant foreign sell-offs and declining market position, making it less attractive for the portfolio. Overall, this portfolio is designed to be diversified and capitalize on stocks with strong potential returns driven by clear catalysts, while mitigating risks associated with each stockâ€™s market position and sentiment.\nBacktest cho phÆ°Æ¡ng phÃ¡p trÃªn Ta tiáº¿n hÃ nh xÃ¢y dá»±ng mÃ´ hÃ¬nh backtest Ä‘Æ¡n giáº£n.\nMua danh má»¥c vÃ o Ä‘áº§u má»—i quÃ½ Bá» qua cÃ¡c yáº¿u tá»‘ nhÆ° phÃ­ giao dá»‹ch, market impact 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ## backtest the strategy - \u003e=35s for 1 loop -\u003e 4 years = 4*4*35s \u003e= 560s ~ 9.3 minutes ## create a function that takes the weights and returns the portfolio returns def backtest_strategy(weights, returns): \"\"\" Backtest the strategy \"\"\" port_rets = returns @ weights port_rets.rename(columns={'weights':'rets'}, inplace=True) return port_rets date_idx = pd.date_range('2020-12-31', '2024-12-31', freq='QE') llm_rets = pd.DataFrame() llm_retionale = {} llm_weights = {} for date in date_idx[:-1]: i = 0 start_sample = date - pd.DateOffset(years=3) end_sample = date start_out_sample = date+ pd.DateOffset(days=1) end_out_sample = date + pd.DateOffset(months=3) ## data for the sample period sample_data = rets[start_sample:end_sample] out_sample = rets[start_out_sample:end_out_sample] # run the optimizer if i \u003e=1: past_port = pd.DataFrame(llm_weights[previous_date.strftime(\"%Y-%m-%d\")]) w, explanation = llm_optimizer(date, past_portfolios=past_port, last_period_return= past_return) else: w, explanation = llm_optimizer(date) llm_retionale[date.strftime(\"%Y-%m-%d\")] = explanation llm_weights[date.strftime(\"%Y-%m-%d\")] = w.to_dict()[\"weights\"] # run the backtest llm_backtest = backtest_strategy(w, out_sample) llm_rets = pd.concat([llm_rets, llm_backtest], axis=0) i+=1 previous_date = date past_return = (1+llm_backtest).product()-1 Tá»« Ä‘Ã³, ta thu Ä‘Æ°á»£c káº¿t quáº£ sau:\nLá»£i nhuáº­n danh má»¥c tá»« 2021 tá»›i nay\nThá»‘ng kÃª liÃªn quan\nLLM VNINDEX Lá»£i nhuáº­n tÃ­ch luá»¹ 70.9% 12.6% Lá»£i nhuáº­n trung bÃ¬nh hÃ ng nÄƒm 14.52% 3.04% Äá»™ biáº¿n Ä‘á»™ng trung bÃ¬nh háº±ng nÄƒm 21.66% 19.6% Sharpe ratio 0.73 0.25 Láº§n sá»¥t giáº£m máº¡nh nháº¥t 24.19% 40.34% Chiáº¿n lÆ°á»£c sá»­ dá»¥ng LLM cho káº¿t quáº£ tÆ°Æ¡ng Ä‘á»‘i tá»‘t vá»›i lá»£i nhuáº­n tÃ­ch luá»¹ 70.9% so vá»›i 12.6% cá»§a vnindex qua 4 nÄƒm. Tuy nhiÃªn, tá»· lá»‡ sharpe thÃ¬ tÆ°Æ¡ng Ä‘á»‘i khiÃªm tá»‘n chá»‰ 0.73 vá»›i Ä‘á»™ biáº¿n Ä‘á»™ng 21.6%. NgoÃ i ra láº§n sá»¥t giáº£m lá»›n nháº¥t Ä‘áº¡t 24.19% lÃ  má»™t káº¿t quáº£ cháº¥p nháº­n Ä‘Æ°á»£c trong Ä‘áº§u tÆ°.\nDanh má»¥c qua tá»«ng giai Ä‘oáº¡n\nKáº¿t luáº­n BÃ i viáº¿t Ä‘Ã£ tiáº¿n hÃ nh xÃ¢y dá»±ng tá»‘i Æ°u hoÃ¡ danh má»¥c sá»­ dá»¥ng LLM. ThÃ´ng qua LLM, ta cÃ³ thá»ƒ Ä‘Æ°a cÃ¡c dá»¯ liá»‡u phi cáº¥u trÃºc (unstructured-data) vÃ o trong quÃ¡ trÃ¬nh tá»‘i Æ°u. ÄÃ¢y lÃ  má»™t Ä‘iá»ƒm thÃº vá»‹ vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng táº­n dá»¥ng cÃ¡c tÃ­nh cháº¥t thá»‘ng kÃª chÆ°a Ä‘Æ°a vÃ o Ä‘Æ°á»£c. Tuy nhiÃªn, pháº£i nháº¥n máº¡nh láº¡i ráº±ng, tá»‘i Æ°u danh má»¥c theo phÆ°Æ¡ng phÃ¡p nÃ y thÃ¬ mang náº·ng yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh (qualitative) hÆ¡n so vá»›i Ä‘á»‹nh lÆ°á»£ng (quantitative).\nMá»™t Ä‘iá»ƒm thÃº vá»‹ nÃ y, ta cÃ³ thá»ƒ káº¿t há»£p 2 phÆ°Æ¡ng phÃ¡p nÃ y vá»›i nhau. ThÃ´ng qua LLM, ta cÃ³ thá»ƒ tÃ¬m ra má»™t prior belief mang tÃ­nh Ä‘á»‹nh tÃ­nh vÃ  dÃ¹ng nÃ³ Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh tá»‘i Æ°u hoÃ¡ Ä‘á»‹nh lÆ°á»£ng hÆ¡n (bayesian style).\nBÃ i viáº¿t sau sáº½ tiáº¿n hÃ nh so sÃ¡nh cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p má»›i nÃ y. Äá»ƒ nháº­n file code vÃ  data Ä‘áº§y Ä‘á»§, xin hÃ£y Ä‘á»ƒ comment vÃ o bÃ i viáº¿t trÃªn linkedin hoáº·c gá»­i email Ä‘áº¿n hung.ha@miquant.vn.\n","wordCount":"3017","inLanguage":"vi","datePublished":"2025-02-03T00:00:00Z","dateModified":"2025-02-03T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"},"publisher":{"@type":"Organization","name":"The Financial Engineer","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="The Financial Engineer (Alt + H)">The Financial Engineer</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/about/ title=About><span>About</span></a></li><li><a href=http://localhost:1313/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM</h1><div class=post-description>Sá»­ dá»¥ng LLM Ä‘á»ƒ tá»‘i Æ°u danh má»¥c Ä‘áº§u tÆ°</div><div class=post-meta><span title='2025-02-03 00:00:00 +0000 UTC'>thÃ¡ng 2 3, 2025</span>&nbsp;Â·&nbsp;15 phÃºt</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Má»¥c lá»¥c</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#concept>Concept</a><ul><li><a href=#tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>Tá»‘i Æ°u hoÃ¡ danh má»¥c</a></li><li><a href=#llm-lÃ -gÃ¬>LLM lÃ  gÃ¬?</a></li><li><a href=#llm-cho-tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>LLM cho tá»‘i Æ°u hoÃ¡ danh má»¥c</a></li></ul></li><li><a href=#xÃ¢y-dá»±ng-danh-má»¥c-Ä‘áº§u-tÆ°-sá»­-dá»¥ng-llm>XÃ¢y dá»±ng danh má»¥c Ä‘áº§u tÆ° sá»­ dá»¥ng LLM</a><ul><li><a href=#thu-tháº­p-tin-tá»©c-tá»«-google>Thu tháº­p tin tá»©c tá»« google</a></li><li><a href=#trÃ­ch-xuáº¥t-cÃ¡c-thÃ´ng-tin-mong-muá»‘n>TrÃ­ch xuáº¥t cÃ¡c thÃ´ng tin mong muá»‘n</a></li><li><a href=#tá»‘i-Æ°u-hoÃ¡-danh-má»¥c-1>Tá»‘i Æ°u hoÃ¡ danh má»¥c</a></li><li><a href=#backtest-cho-phÆ°Æ¡ng-phÃ¡p-trÃªn>Backtest cho phÆ°Æ¡ng phÃ¡p trÃªn</a></li></ul></li><li><a href=#káº¿t-luáº­n>Káº¿t luáº­n</a></li></ul></nav></div></details></div><div class=post-content><p><img loading=lazy src=images/1.png#center alt=1.png></p><p>BÃ i viáº¿t nÃ y thá»­ nghiá»‡m tá»‘i Æ°u hoÃ¡ danh má»¥c sá»­ dá»¥ng Large Language Model (LLM). ThÆ° viá»‡n langchain vÃ  OpenAI gpt4o vÃ  4o-mini sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng cho thá»­ nghiá»‡m.</p><h2 id=concept>Concept<a hidden class=anchor aria-hidden=true href=#concept>#</a></h2><h3 id=tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>Tá»‘i Æ°u hoÃ¡ danh má»¥c<a hidden class=anchor aria-hidden=true href=#tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>#</a></h3><p>Tá»‘i Æ°u hÃ³a danh má»¥c Ä‘áº§u tÆ° lÃ  quÃ¡ trÃ¬nh phÃ¢n bá»• tÃ i sáº£n vÃ o cÃ¡c khoáº£n Ä‘áº§u tÆ° khÃ¡c nhau nháº±m Ä‘áº¡t Ä‘Æ°á»£c sá»± cÃ¢n báº±ng tá»‘i Æ°u giá»¯a lá»£i nhuáº­n ká»³ vá»ng vÃ  rá»§i ro. CÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a truyá»n thá»‘ng, nhÆ° Modern Portfolio Theory hay Mean-variance optimization, chá»§ yáº¿u dá»±a vÃ o dá»¯ liá»‡u lá»‹ch sá»­ vÃ  cÃ¡c giáº£ Ä‘á»‹nh vá» phÃ¢n phá»‘i lá»£i nhuáº­n. Tuy nhiÃªn, chÃºng cÃ³ má»™t sá»‘ háº¡n cháº¿:</p><ul><li><strong>KhÃ³ khÄƒn trong viá»‡c tÃ­ch há»£p cÃ¡c yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh</strong>: CÃ¡c phÆ°Æ¡ng phÃ¡p nÃ y thÆ°á»ng khÃ´ng xem xÃ©t cÃ¡c yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh nhÆ° tin tá»©c thá»‹ trÆ°á»ng, sá»± kiá»‡n kinh táº¿ hoáº·c quan Ä‘iá»ƒm cá»§a chuyÃªn gia, tiá»m nÄƒng tá»« cÃ¢u chuyá»‡n kinh doanh dáº«n Ä‘áº¿n viá»‡c thiáº¿u linh hoáº¡t trong pháº£n á»©ng vá»›i cÃ¡c biáº¿n Ä‘á»™ng thá»‹ trÆ°á»ng.</li><li><strong>Giáº£ Ä‘á»‹nh Ä‘Æ¡n giáº£n hÃ³a</strong>: Viá»‡c giáº£ Ä‘á»‹nh ráº±ng lá»£i nhuáº­n tuÃ¢n theo phÃ¢n phá»‘i chuáº©n vÃ  má»‘i quan há»‡ giá»¯a cÃ¡c tÃ i sáº£n lÃ  tuyáº¿n tÃ­nh cÃ³ thá»ƒ khÃ´ng pháº£n Ã¡nh chÃ­nh xÃ¡c thá»±c táº¿ phá»©c táº¡p cá»§a thá»‹ trÆ°á»ng.</li></ul><h3 id=llm-lÃ -gÃ¬>LLM lÃ  gÃ¬?<a hidden class=anchor aria-hidden=true href=#llm-lÃ -gÃ¬>#</a></h3><p>MÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (LLM) lÃ  cÃ¡c mÃ´ hÃ¬nh há»c sÃ¢u Ä‘Æ°á»£c huáº¥n luyá»‡n trÃªn khá»‘i lÆ°á»£ng dá»¯ liá»‡u vÄƒn báº£n khá»•ng lá»“, giÃºp chÃºng cÃ³ kháº£ nÄƒng hiá»ƒu vÃ  táº¡o ra ngÃ´n ngá»¯ tá»± nhiÃªn. Vá»›i kháº£ nÄƒng Ä‘á»c hiá»ƒu ngÃ´n ngá»¯ nÃ y, LLM cÃ³ thá»ƒ trÃ­ch xuáº¥t thÃ´ng tin vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u phi cáº¥u trÃºc nhanh chÃ³ng vÃ  Ä‘Æ¡n giáº£n hÆ¡n nhiá»u so vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng. VÃ­ dá»¥, LLM cÃ³ thá»ƒ Ä‘á»c 10 bÃ i bÃ¡o gáº§n Ä‘Ã¢y vÃ  tá»•ng há»£p ra 3 luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° phá»• biáº¿n nháº¥t tá»« cÃ¡c bÃ i bÃ¡o Ä‘Ã³â€”má»™t nhiá»‡m vá»¥ mÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng khÃ³ thá»±c hiá»‡n Ä‘Æ°á»£c.</p><p>Táº£n máº¡n: má»™t cÃ¡ch khoa há»c mÃ  nÃ³i, chÃºng ta cÃ³ thá»ƒ &ldquo;hÃ¬nh dung&rdquo; LLM nhÆ° sau: LLM lÃ  má»™t cá»— mÃ¡y Ä‘Æ°a ra káº¿t quáº£ dá»±a trÃªn trÆ°á»ng há»£p cÃ³ xÃ¡c suáº¥t cao nháº¥t. CÃ¡c cÃ¢u prompt Ä‘Ã³ng vai trÃ² giá»›i háº¡n pháº¡m vi lá»±a chá»n cá»§a LLM, tá»« Ä‘Ã³ tÄƒng xÃ¡c suáº¥t cho káº¿t quáº£ mong muá»‘n.</p><h3 id=llm-cho-tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>LLM cho tá»‘i Æ°u hoÃ¡ danh má»¥c<a hidden class=anchor aria-hidden=true href=#llm-cho-tá»‘i-Æ°u-hoÃ¡-danh-má»¥c>#</a></h3><p>Vá»›i kháº£ nÄƒng phÃ¢n tÃ­ch vÃ  táº­n dá»¥ng cÃ¡c dá»¯ liá»‡u phi cáº¥u trÃºc trÃªn, LLM lÃ  má»™t á»©ng cá»­ viÃªn sÃ¡ng giÃ¡ cho quÃ¡ trÃ¬nh tá»‘i Æ°u hoÃ¡ danh má»¥c khi cÃ³ thá»ƒ táº­n dá»¥ng Ä‘Æ°á»£c: (1) dá»¯ liá»‡u cÃ³ cáº¥u trÃºc, thá»‘ng kÃª lá»£i nhuáº­n rá»§i ro; (2) dá»¯ liá»‡u phi cáº¥u trÃºc nhÆ° tiá»m nÄƒng tÄƒng trÆ°á»Ÿng cÃ´ng ty, â€¦; (3) Ä‘Ã¡p á»©ng Ä‘Æ°á»£c cÃ¡c yÃªu cáº§u vá» má»¥c tiÃªu Ä‘áº§u tÆ° (objective), hay cÃ¡c ráº±ng buá»™c Ä‘i kÃ¨m (constraints) má»™t cÃ¡c nhanh chÃ³ng.</p><p>Äá»ƒ dá»… dÃ ng hÃ¬nh dung, chÃºng ta sáº½ cÃ¹ng nhau Ä‘i qua thá»­ nghiá»‡m thá»±c táº¿ cho 6 cá»• phiáº¿u FPT, HPG, MWG, REE, VCB vÃ  VNM!</p><h2 id=xÃ¢y-dá»±ng-danh-má»¥c-Ä‘áº§u-tÆ°-sá»­-dá»¥ng-llm>XÃ¢y dá»±ng danh má»¥c Ä‘áº§u tÆ° sá»­ dá»¥ng LLM<a hidden class=anchor aria-hidden=true href=#xÃ¢y-dá»±ng-danh-má»¥c-Ä‘áº§u-tÆ°-sá»­-dá»¥ng-llm>#</a></h2><p>Quy trÃ¬nh tá»‘i Æ°u sáº½ nhau sau</p><ul><li>B1: XÃ¡c Ä‘á»‹nh rá»• cá»• phiáº¿u Ä‘áº§u tÆ°</li><li>B2: Thu tháº­p thÃ´ng tin: (1) Sentiment cá»§a cá»• phiáº¿u; (2) CÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° - rá»§i ro cá»§a cá»• phiáº¿u; (3) tÃ­n hiá»‡u kÄ© thuáº­t; (4) Äá»™ tÆ°Æ¡ng quan giá»¯a cÃ¡c cá»• phiáº¿u vá»›i nhau</li><li>B3: Tá»‘i Æ°u hoÃ¡ danh má»¥c: (1) CÃ¡c má»¥c tiÃªu Ä‘áº§u tÆ° cÅ©ng nhÆ° giá»›i háº¡n cho phÃ©p; (2) Xem xÃ©t danh má»¥c quÃ¡ khá»© vÃ  hiá»‡u suáº¥t quÃ½ gáº§n nháº¥t.</li><li>B4: Backtest</li></ul><p><img loading=lazy src=images/2.png#center alt=2.png></p><h3 id=thu-tháº­p-tin-tá»©c-tá»«-google>Thu tháº­p tin tá»©c tá»« google<a hidden class=anchor aria-hidden=true href=#thu-tháº­p-tin-tá»©c-tá»«-google>#</a></h3><p>Táº¡i bÆ°á»›c Ä‘áº§u tiÃªn, chÃºng ta cáº§n xÃ¢y dá»±ng má»™t pipeline Ä‘á»ƒ thu tháº­p Ä‘Æ°á»£c cÃ¡c tin tá»©c liÃªn quan Ä‘áº¿n tá»«ng cá»• phiáº¿u, vÃ  pháº£i phÃ¹ há»£p vá»›i thá»i gian cá»§a giai Ä‘oáº¡n backtest. Táº¡i khÃ¢u nÃ y, chÃºng ta sáº½ sá»­ dá»¥ng thÆ° viá»‡n langchain Ä‘á»ƒ xÃ¢y dá»±ng pipeline vÃ  mÃ´ hÃ¬nh gpt-4o-mini Ä‘á»ƒ xá»­ lÃ½ tin tá»©c</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_google_news_before</span>(query: str, before_date: datetime<span style=color:#f92672>.</span>date, num_results: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Query Google News via LangChainâ€™s Google Serper API Wrapper, filtering articles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    so that only those published before the given date are returned.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cd_min <span style=color:#f92672>=</span> convert_date_to_str(before_date <span style=color:#f92672>-</span> datetime<span style=color:#f92672>.</span>timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>))
</span></span><span style=display:flex><span>    cd_max <span style=color:#f92672>=</span> convert_date_to_str(before_date)
</span></span><span style=display:flex><span>    tbs <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;cdr:1,cd_min:</span><span style=color:#e6db74>{</span>cd_min<span style=color:#e6db74>}</span><span style=color:#e6db74>,cd_max:</span><span style=color:#e6db74>{</span>cd_max<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    search <span style=color:#f92672>=</span> GoogleSerperAPIWrapper(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;news&#34;</span>, tbs<span style=color:#f92672>=</span>tbs, gl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vn&#34;</span>,hl<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;vi&#39;</span>,k<span style=color:#f92672>=</span>num_results)
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> search<span style=color:#f92672>.</span>results(query)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> results
</span></span></code></pre></td></tr></table></div></div><p>Ta cÃ³ thá»ƒ dá»… dÃ ng táº¡o ra má»™t hÃ m Ä‘á»c tin tá»©c sá»­ dá»¥ng <a href=https://serper.dev>Serper</a> vÃ  thÆ° viá»‡n langchain. HÃ m trÃªn thiáº¿t káº¿ Ä‘á»ƒ láº¥y cÃ¡c tin tá»©c trong vÃ o 90 ngÃ y trÆ°á»›c ngÃ y truyá»n vÃ o.</p><h3 id=trÃ­ch-xuáº¥t-cÃ¡c-thÃ´ng-tin-mong-muá»‘n>TrÃ­ch xuáº¥t cÃ¡c thÃ´ng tin mong muá»‘n<a hidden class=anchor aria-hidden=true href=#trÃ­ch-xuáº¥t-cÃ¡c-thÃ´ng-tin-mong-muá»‘n>#</a></h3><p>Äá»ƒ thu tháº­p thÃ´ng tin phá»¥c vá»¥ Ä‘áº§u tÆ°, ta tÃ¬m kiáº¿m cÃ¡c bÃ i bÃ¡o vá»›i tá»« khÃ³a &ldquo;Ä‘áº§u tÆ° vÃ o cá»• phiáº¿u ABC&rdquo;, trong Ä‘Ã³ ABC lÃ  mÃ£ cá»• phiáº¿u cáº§n phÃ¢n tÃ­ch.</p><p>Sau khi cÃ³ Ä‘Æ°á»£c cÃ¡c bÃ i bÃ¡o liÃªn quan, ta thu tháº­p cÃ¡c thÃ´ng tin quan trá»ng bao gá»“m: (1) sentiment cá»§a cá»• phiáº¿u trong quÃ½ vá»«a qua; (2) lÃ½ giáº£i cho káº¿t quáº£ sentiment Ä‘Ã³; (3) cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° (Catalyst); (4) cÃ¡c yáº¿u tá»‘ rá»§i ro.</p><p>Äá»ƒ thá»±c hiá»‡n viá»‡c nÃ y, ta thiáº¿t káº¿ cÃ¢u prompt dá»±a trÃªn cÃ¡c yÃªu cáº§u trÃªn vÃ  sá»­ dá»¥ng mÃ´ hÃ¬nh LLM gpt-4o-mini. VÃ¬ nhiá»‡m vá»¥ nÃ y chá»§ yáº¿u lÃ  tá»•ng há»£p thÃ´ng tin, khÃ´ng Ä‘Ã²i há»i nhiá»u suy luáº­n phá»©c táº¡p, nÃªn viá»‡c sá»­ dá»¥ng má»™t mÃ´ hÃ¬nh nhá» gá»n, nhanh vÃ  tiáº¿t kiá»‡m nhÆ° gpt-4o-mini lÃ  lá»±a chá»n phÃ¹ há»£p.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>## Sá»­ dá»¥ng pydantic Ä‘á»ƒ Ã©p model tráº£ vá» dáº¡ng dá»¯ liá»‡u nhÆ° mong muá»‘n</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sentiment</span>(BaseModel):
</span></span><span style=display:flex><span>    sentiment: str <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The financial market sentiment of all news&#34;</span>, enum<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;bearish&#34;</span>, <span style=color:#e6db74>&#34;bullish&#34;</span>, <span style=color:#e6db74>&#34;neutral&#34;</span>])
</span></span><span style=display:flex><span>    explanation: str <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The short explanation about the chosen sentiment &#34;</span>)
</span></span><span style=display:flex><span>    catalyst: List[str] <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The catalyst based on all news&#34;</span>)
</span></span><span style=display:flex><span>    risk_factor: List[str] <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The risk factor based on all news&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extract_key_info</span>(stock , date):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Extract key information from a news article.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    nest_asyncio<span style=color:#f92672>.</span>apply()
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Ä‘áº§u tÆ° cá»• phiáº¿u </span><span style=color:#e6db74>{</span>stock<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># For example, retrieve articles published before January 1, 2025.</span>
</span></span><span style=display:flex><span>    cutoff_date <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    articles <span style=color:#f92672>=</span> load_google_news_before(query, cutoff_date, num_results<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>    links <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(articles[<span style=color:#e6db74>&#39;news&#39;</span>])[<span style=color:#e6db74>&#39;link&#39;</span>]<span style=color:#f92672>.</span>to_list()
</span></span><span style=display:flex><span>    <span style=color:#75715e>## drop the link from https://etime.danviet.vn</span>
</span></span><span style=display:flex><span>    links <span style=color:#f92672>=</span> [link <span style=color:#66d9ef>for</span> link <span style=color:#f92672>in</span> links <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;danviet.vn&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> link] <span style=color:#75715e>## skip for danviet.vn as it block the request</span>
</span></span><span style=display:flex><span>    loader <span style=color:#f92672>=</span> WebBaseLoader(links, continue_on_failure<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    loader<span style=color:#f92672>.</span>requests_per_second <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span>    docs <span style=color:#f92672>=</span> loader<span style=color:#f92672>.</span>aload()
</span></span><span style=display:flex><span>    ls <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> doc <span style=color:#f92672>in</span> docs:
</span></span><span style=display:flex><span>        ls<span style=color:#f92672>.</span>append(doc<span style=color:#f92672>.</span>page_content<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39; &#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    llm <span style=color:#f92672>=</span> ChatOpenAI(model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gpt-4o-mini&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    You&#39;re a senior analyst. You are analyzing stock </span><span style=color:#e6db74>{stock}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Your tasks are: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Analyze the sentiment of the given news
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Explain the sentiment in few words
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Identify the key catalysts or drivers
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Identify the risk factors
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>{document}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Requirement
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Be specific and concise
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Do not make up information or make assumption
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Do not use external source
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(stock <span style=color:#f92672>=</span> stock,document<span style=color:#f92672>=</span>ls)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> llm<span style=color:#f92672>.</span>with_structured_output(Sentiment)<span style=color:#f92672>.</span>invoke(prompt)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>date <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>date(<span style=color:#ae81ff>2024</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>extract_key_info(<span style=color:#e6db74>&#39;HPG&#39;</span>, date)
</span></span></code></pre></td></tr></table></div></div><p>Káº¿t quáº£ cá»§a hÃ m trÃªn sáº½ nhÆ° sau:</p><p>Sentiment(sentiment=&lsquo;bearish&rsquo;, explanation=&lsquo;Sentiment is bearish due to significant losses reported by HPG and related companies, along with ongoing challenges in the steel market.&rsquo;, catalyst=[&lsquo;Increased production and sales in October 2023&rsquo;, &lsquo;Expected recovery in demand and prices for steel&rsquo;, &lsquo;Completion of Dung Quáº¥t 2 project may increase capacity&rsquo;], risk_factor=[&lsquo;High competition in the steel industry&rsquo;, &lsquo;Dependence on domestic market recovery&rsquo;, &lsquo;Fluctuations in raw material prices&rsquo;])</p><h3 id=tá»‘i-Æ°u-hoÃ¡-danh-má»¥c-1>Tá»‘i Æ°u hoÃ¡ danh má»¥c<a hidden class=anchor aria-hidden=true href=#tá»‘i-Æ°u-hoÃ¡-danh-má»¥c-1>#</a></h3><p>Khi tá»‘i Æ°u hoÃ¡ danh má»¥c, viá»‡c xÃ¢y dá»±ng cÃ¢u prompt chi tiáº¿t vÃ  cá»¥ thá»ƒ sáº½ giÃºp giáº£m thiá»ƒu lá»—i vÃ  táº¡o ra tá»· trá»ng há»£p lÃ½ hÆ¡n. Do Ä‘á»™ phá»©c táº¡p táº¡i khÃ¢u nÃ y tÄƒng cao, chÃºng ta cáº§n sá»­ dá»¥ng má»™t mÃ´ hÃ¬nh LLM máº¡nh máº½ hÆ¡n. BÃ i viáº¿t chá»n sá»­ dá»¥ng <strong>gpt-4o.</strong></p><p><strong>Má»¥c tiÃªu Ä‘áº§u tÆ°</strong>: PhÃ¢n bá»• tá»· trá»ng cho cÃ¡c cá»• phiáº¿u cÃ³ tiá»m nÄƒng tÄƒng trÆ°á»Ÿng cao, dá»±a trÃªn tÃ­n hiá»‡u ká»¹ thuáº­t, sentiment vÃ  cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ°.</p><p><strong>CÃ¡c ráº±ng buá»™c:</strong></p><ul><li>Long-only portfolio</li><li>KhÃ´ng sá»­ dá»¥ng margin</li><li>Hold trong 3 thÃ¡ng</li><li>KhÃ´ng cáº§n Ä‘áº§u tÆ° háº¿t 6 cá»• phiáº¿u nhÆ°ng pháº£i cÃ³ Ã­t nháº¥t 4 cá»• phiáº¿u</li></ul><p>NgoÃ i ra, cÃ¢u prompt cÅ©ng bao gá»“m má»™t workflow (quy trÃ¬nh) Ä‘á»ƒ LLM cÃ³ thá»ƒ dá»±a vÃ o Ä‘Ã³ Ä‘á»ƒ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh phÃ¢n bá»• tá»· trá»ng</p><ol><li>Dá»±a trÃªn cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c cá»• phiáº¿u tiá»m nÄƒng</li><li>ÄÃ¡nh giÃ¡ sentiment cá»§a cÃ¡c cá»• phiáº¿u Ä‘Ã£ chá»n</li><li>Sá»­ dá»¥ng tÃ­n hiá»‡u ká»¹ thuáº­t Ä‘á»ƒ xÃ¡c nháº­n thÃªm tiá»m nÄƒng cá»§a cÃ¡c cá»• phiáº¿u</li><li>Cuá»‘i cÃ¹ng, sá»­ dá»¥ng dá»¯ liá»‡u rá»§i ro-lá»£i nhuáº­n cá»§a 3 thÃ¡ng qua Ä‘á»ƒ xÃ¡c Ä‘á»‹nh cÃ¡c cá»• phiáº¿u Ä‘Æ°á»£c mua quÃ¡ má»©c hoáº·c bá»‹ thá»•i phá»“ng, trÃ¡nh phÃ¢n bá»• quÃ¡ nhiá»u vá»‘n cho chÃºng. Tuy nhiÃªn, náº¿u luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° há»©a háº¹n, ta váº«n cÃ³ thá»ƒ phÃ¢n bá»• tiá»n cho cá»• phiáº¿u Ä‘Ã³ náº¿u tin ráº±ng nÃ³ cÃ³ tiá»m nÄƒng Ä‘Ã¡ng ká»ƒ</li><li>Chia tá»· trá»ng cho tá»«ng cá»• phiáº¿u dá»±a trÃªn tiá»m nÄƒng cá»§a cÃ¡c luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ°</li><li>PhÃ¢n bá»• nhiá»u tá»· trá»ng hÆ¡n cho cÃ¡c cá»• phiáº¿u cÃ³ luáº­n Ä‘iá»ƒm Ä‘áº§u tÆ° kháº£ thi vÃ  tiá»m nÄƒng cao</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Create a portfolio with the following stocks: </span><span style=color:#e6db74>{stocks}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Objective:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Use the technical signal, market sentiment and catalysts to assign weight to each stock for a long-only portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The portfolio aim to invest in the stock with the highest potential return
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Constraints:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The portfolio should be well diversified
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- You can invest in each stock with a maximum of 0.5 of the portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- You do not need to invest in all stocks, but you must invest in at least 4 stocks. Only select the most promising stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- There is no leverage &amp; short selling
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The holding period is 3 months (1 quarter)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The weight should be a float number between 0 and 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The sum of all weights should be 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Workflow:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1. Analyze information first. 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>2. Based on the catalysts, identify the stocks that are likely to perform well.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>3. Assess the sentiment of the news to confirm the potential of the selected stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>4. Use the technical signal to further confirm the potential of the stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>5. Finally, use the past 3 months&#39; risk-return data to identify overbought or hyped stocks to avoid allocating too much capital to them. However, if the catalyst is highly promising, you may still allocate funds to it if you believe it has significant potential.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>6. Assign weights to each stock based on the potential return driven by the catalyst.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>7. Allocate more weight to stocks where the catalyst is more likely to occur and has a higher magnitude.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>8. Be confident in assigning higher weights to stocks with better catalysts and sentiment.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>9. **Think carefully; do not simply split the weights equally.**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Technical signal: simple EMA50-200 crossover, 1 for bullish, 0 for bearish
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{ta_signal}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Past 3 risk return
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{risk_return}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>News sentiment (0 for bearish, 1 for bullish, 2 for neutral) &amp; Catalysts
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{sentiment}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Correlation between stocks
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{correlation}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Your previous portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{past_portfolios}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Your previous return: </span><span style=color:#e6db74>{last_period_return}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Output
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- A list with weight for every stock. The weight must correspond to the oder </span><span style=color:#e6db74>{stocks}</span><span style=color:#e6db74>. For stock that not invest, simple return 0 for the weight
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- A detailed explanation of the rationale behind the portfolio allocation
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau Ä‘Ã³, ta sáº½ tÃ­nh toÃ¡n cÃ¡c tham sá»‘ vÃ  Ä‘Æ°a cÃ¡c thÃ´ng tin cáº§n thiáº¿t vÃ o trong mÃ´ hÃ¬nh Ä‘á»ƒ mÃ´ hÃ¬nh thá»±c hiá»‡n vÃ  tÃ­nh toÃ¡n.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PortfolioOptimizationResult</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    A class to represent the result of portfolio optimization.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    stock_weight: List[float] <span style=color:#f92672>=</span> Field(
</span></span><span style=display:flex><span>        default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A list containing the weight for all stocks in the portfolio.&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    explanation: str <span style=color:#f92672>=</span> Field(
</span></span><span style=display:flex><span>        default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A detailed explanation of the rationale behind the portfolio allocation.&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>llm_optimizer</span>(date, stocks <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;FPT&#39;</span>, <span style=color:#e6db74>&#39;HPG&#39;</span>, <span style=color:#e6db74>&#39;MWG&#39;</span>, <span style=color:#e6db74>&#39;REE&#39;</span>, <span style=color:#e6db74>&#39;VCB&#39;</span>, <span style=color:#e6db74>&#39;VNM&#39;</span>], past_portfolios <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, last_period_return <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> run_in_parallel(stocks, date)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    llm <span style=color:#f92672>=</span> ChatOpenAI(model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gpt-4o&#39;</span>)
</span></span><span style=display:flex><span>    ta_signal <span style=color:#f92672>=</span> ta_compare[:date]<span style=color:#f92672>.</span>iloc[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    start_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>-</span> datetime<span style=color:#f92672>.</span>timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#ae81ff>3</span>) <span style=color:#75715e>## 3 months</span>
</span></span><span style=display:flex><span>    sample_rets <span style=color:#f92672>=</span> rets[start_sample:date]
</span></span><span style=display:flex><span>    risk_return <span style=color:#f92672>=</span> ((<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span>sample_rets)<span style=color:#f92672>.</span>product()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>to_frame()
</span></span><span style=display:flex><span>    risk_return<span style=color:#f92672>.</span>columns <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;past_3m_rets&#39;</span>]
</span></span><span style=display:flex><span>    risk_return[<span style=color:#e6db74>&#39;past_3m_volatility&#39;</span>] <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>std()
</span></span><span style=display:flex><span>    risk_return[<span style=color:#e6db74>&#39;past_3m_sharpe_ratio&#39;</span>] <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>mean()<span style=color:#f92672>/</span>risk_return[<span style=color:#e6db74>&#39;past_3m_volatility&#39;</span>]
</span></span><span style=display:flex><span>    risk_return <span style=color:#f92672>=</span> risk_return<span style=color:#f92672>.</span>round(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    correlation <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>corr()<span style=color:#f92672>.</span>round(<span style=color:#ae81ff>4</span>)   
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    chatprompt <span style=color:#f92672>=</span> prompt<span style=color:#f92672>.</span>format(ta_signal<span style=color:#f92672>=</span>ta_signal, sentiment<span style=color:#f92672>=</span>results, risk_return<span style=color:#f92672>=</span>risk_return, stocks<span style=color:#f92672>=</span>stocks, correlation<span style=color:#f92672>=</span>correlation, past_portfolios<span style=color:#f92672>=</span>past_portfolios, last_period_return<span style=color:#f92672>=</span>last_period_return)
</span></span><span style=display:flex><span>    optimizer <span style=color:#f92672>=</span> llm<span style=color:#f92672>.</span>with_structured_output(PortfolioOptimizationResult)<span style=color:#f92672>.</span>invoke(chatprompt)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    weight <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(optimizer<span style=color:#f92672>.</span>stock_weight, index<span style=color:#f92672>=</span>stocks, columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;weights&#39;</span>])
</span></span><span style=display:flex><span>    weight <span style=color:#f92672>=</span> weight<span style=color:#f92672>/</span>weight<span style=color:#f92672>.</span>sum() <span style=color:#75715e>## make sure the sum of weight is 1</span>
</span></span><span style=display:flex><span>    retionale <span style=color:#f92672>=</span> optimizer<span style=color:#f92672>.</span>explanation
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> weight, retionale
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>weight, expla <span style=color:#f92672>=</span> llm_optimizer(datetime<span style=color:#f92672>.</span>date(<span style=color:#ae81ff>2024</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)) <span style=color:#75715e>## this takes around 35 seconds</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau khi cháº¡y hÃ m trÃªn, ta sáº½ nháº­n Ä‘Æ°á»£c káº¿t quáº£ nhÆ° sau (danh má»¥c cho thÃ¡ng 6.2024):</p><p>Tá»· trá»ng danh má»¥c</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left>weights</th></tr></thead><tbody><tr><td style=text-align:left>FPT</td><td style=text-align:left>0.25</td></tr><tr><td style=text-align:left>HPG</td><td style=text-align:left>0.2</td></tr><tr><td style=text-align:left>MWG</td><td style=text-align:left>0.3</td></tr><tr><td style=text-align:left>REE</td><td style=text-align:left>0.15</td></tr><tr><td style=text-align:left>VCB</td><td style=text-align:left>0.1</td></tr><tr><td style=text-align:left>VNM</td><td style=text-align:left>0.0</td></tr></tbody></table><p>LÃ½ do cho tá»· trá»ng trÃªn</p><aside>ğŸ’¡<p>In constructing this portfolio, we focused on stocks with strong bullish technical signals and favorable market sentiment, while considering catalysts and risks.</p><ol><li><strong>FPT (Weight: 0.25)</strong>: FPT has a bullish technical signal, strong sentiment driven by its partnership with NVIDIA for AI development, and projected revenue growth. Although its valuation is high, its catalysts are promising, warranting a significant allocation.</li><li><strong>HPG (Weight: 0.2)</strong>: HPG also exhibits a bullish technical signal and optimistic market sentiment due to strong Q1 financial results and upcoming projects like Dung Quáº¥t 2. Despite high debt levels, its growth potential justifies a substantial allocation.</li><li><strong>MWG (Weight: 0.3)</strong>: MWG has demonstrated strong past returns and a bullish sentiment, supported by strategic investments and projected growth. The high weight reflects its potential for recovery and profit, despite some risks.</li><li><strong>REE (Weight: 0.15)</strong>: REE&rsquo;s neutral sentiment and mixed outlook are balanced by its dividend plans and growth in renewable energy. Its lower weight reflects these uncertainties, but its diversification benefits and potential in energy justify inclusion.</li><li><strong>VCB (Weight: 0.1)</strong>: Despite a neutral sentiment and recent negative returns, VCB&rsquo;s catalysts such as planned capital increases and potential equity sales offer upside potential, meriting a smaller allocation.</li><li><strong>VNM (Weight: 0)</strong>: VNM is excluded due to bearish sentiment and negative past performance, with significant foreign sell-offs and declining market position, making it less attractive for the portfolio.</li></ol><p>Overall, this portfolio is designed to be diversified and capitalize on stocks with strong potential returns driven by clear catalysts, while mitigating risks associated with each stock&rsquo;s market position and sentiment.</p></aside><h3 id=backtest-cho-phÆ°Æ¡ng-phÃ¡p-trÃªn>Backtest cho phÆ°Æ¡ng phÃ¡p trÃªn<a hidden class=anchor aria-hidden=true href=#backtest-cho-phÆ°Æ¡ng-phÃ¡p-trÃªn>#</a></h3><p>Ta tiáº¿n hÃ nh xÃ¢y dá»±ng mÃ´ hÃ¬nh backtest Ä‘Æ¡n giáº£n.</p><ul><li>Mua danh má»¥c vÃ o Ä‘áº§u má»—i quÃ½</li><li>Bá» qua cÃ¡c yáº¿u tá»‘ nhÆ° phÃ­ giao dá»‹ch, market impact</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>## backtest the strategy - &gt;=35s for 1 loop -&gt; 4 years = 4*4*35s &gt;= 560s ~ 9.3 minutes</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## create a function that takes the weights and returns the portfolio returns</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>backtest_strategy</span>(weights, returns):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Backtest the strategy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    port_rets <span style=color:#f92672>=</span>  returns <span style=color:#f92672>@</span> weights
</span></span><span style=display:flex><span>    port_rets<span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;weights&#39;</span>:<span style=color:#e6db74>&#39;rets&#39;</span>}, inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> port_rets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date_idx <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>date_range(<span style=color:#e6db74>&#39;2020-12-31&#39;</span>, <span style=color:#e6db74>&#39;2024-12-31&#39;</span>, freq<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;QE&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>llm_rets <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame()
</span></span><span style=display:flex><span>llm_retionale <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>llm_weights <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> date <span style=color:#f92672>in</span> date_idx[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]:
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    start_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>-</span> pd<span style=color:#f92672>.</span>DateOffset(years<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    end_sample <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    start_out_sample <span style=color:#f92672>=</span> date<span style=color:#f92672>+</span> pd<span style=color:#f92672>.</span>DateOffset(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    end_out_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>+</span> pd<span style=color:#f92672>.</span>DateOffset(months<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>## data for the sample period</span>
</span></span><span style=display:flex><span>    sample_data <span style=color:#f92672>=</span> rets[start_sample:end_sample]
</span></span><span style=display:flex><span>    out_sample <span style=color:#f92672>=</span> rets[start_out_sample:end_out_sample]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># run the optimizer</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        past_port <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(llm_weights[previous_date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)])
</span></span><span style=display:flex><span>        w, explanation <span style=color:#f92672>=</span> llm_optimizer(date, past_portfolios<span style=color:#f92672>=</span>past_port, last_period_return<span style=color:#f92672>=</span> past_return)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        w, explanation <span style=color:#f92672>=</span> llm_optimizer(date)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    llm_retionale[date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> explanation
</span></span><span style=display:flex><span>    llm_weights[date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> w<span style=color:#f92672>.</span>to_dict()[<span style=color:#e6db74>&#34;weights&#34;</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># run the backtest</span>
</span></span><span style=display:flex><span>    llm_backtest <span style=color:#f92672>=</span> backtest_strategy(w, out_sample)
</span></span><span style=display:flex><span>    llm_rets <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat([llm_rets, llm_backtest], axis<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    i<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    previous_date <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    past_return <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span>llm_backtest)<span style=color:#f92672>.</span>product()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></td></tr></table></div></div><p>Tá»« Ä‘Ã³, ta thu Ä‘Æ°á»£c káº¿t quáº£ sau:</p><p>Lá»£i nhuáº­n danh má»¥c tá»« 2021 tá»›i nay</p><p><img loading=lazy src=images/3.png#center alt=3.png></p><p>Thá»‘ng kÃª liÃªn quan</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left><strong>LLM</strong></th><th style=text-align:left><strong>VNINDEX</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Lá»£i nhuáº­n tÃ­ch luá»¹</strong></td><td style=text-align:left>70.9%</td><td style=text-align:left>12.6%</td></tr><tr><td style=text-align:left><strong>Lá»£i nhuáº­n trung bÃ¬nh hÃ ng nÄƒm</strong></td><td style=text-align:left>14.52%</td><td style=text-align:left>3.04%</td></tr><tr><td style=text-align:left><strong>Äá»™ biáº¿n Ä‘á»™ng trung bÃ¬nh háº±ng nÄƒm</strong></td><td style=text-align:left>21.66%</td><td style=text-align:left>19.6%</td></tr><tr><td style=text-align:left><strong>Sharpe ratio</strong></td><td style=text-align:left>0.73</td><td style=text-align:left>0.25</td></tr><tr><td style=text-align:left><strong>Láº§n sá»¥t giáº£m máº¡nh nháº¥t</strong></td><td style=text-align:left>24.19%</td><td style=text-align:left>40.34%</td></tr></tbody></table><p>Chiáº¿n lÆ°á»£c sá»­ dá»¥ng LLM cho káº¿t quáº£ tÆ°Æ¡ng Ä‘á»‘i tá»‘t vá»›i lá»£i nhuáº­n tÃ­ch luá»¹ 70.9% so vá»›i 12.6% cá»§a vnindex qua 4 nÄƒm. Tuy nhiÃªn, tá»· lá»‡ sharpe thÃ¬ tÆ°Æ¡ng Ä‘á»‘i khiÃªm tá»‘n chá»‰ 0.73 vá»›i Ä‘á»™ biáº¿n Ä‘á»™ng 21.6%. NgoÃ i ra láº§n sá»¥t giáº£m lá»›n nháº¥t Ä‘áº¡t 24.19% lÃ  má»™t káº¿t quáº£ cháº¥p nháº­n Ä‘Æ°á»£c trong Ä‘áº§u tÆ°.</p><p>Danh má»¥c qua tá»«ng giai Ä‘oáº¡n</p><p><img loading=lazy src=images/4.png#center alt=4.png></p><h2 id=káº¿t-luáº­n>Káº¿t luáº­n<a hidden class=anchor aria-hidden=true href=#káº¿t-luáº­n>#</a></h2><p>BÃ i viáº¿t Ä‘Ã£ tiáº¿n hÃ nh xÃ¢y dá»±ng tá»‘i Æ°u hoÃ¡ danh má»¥c sá»­ dá»¥ng LLM. ThÃ´ng qua LLM, ta cÃ³ thá»ƒ Ä‘Æ°a cÃ¡c dá»¯ liá»‡u phi cáº¥u trÃºc (unstructured-data) vÃ o trong quÃ¡ trÃ¬nh tá»‘i Æ°u. ÄÃ¢y lÃ  má»™t Ä‘iá»ƒm thÃº vá»‹ vÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng táº­n dá»¥ng cÃ¡c tÃ­nh cháº¥t thá»‘ng kÃª chÆ°a Ä‘Æ°a vÃ o Ä‘Æ°á»£c. Tuy nhiÃªn, pháº£i nháº¥n máº¡nh láº¡i ráº±ng, tá»‘i Æ°u danh má»¥c theo phÆ°Æ¡ng phÃ¡p nÃ y thÃ¬ mang náº·ng yáº¿u tá»‘ Ä‘á»‹nh tÃ­nh (qualitative) hÆ¡n so vá»›i Ä‘á»‹nh lÆ°á»£ng (quantitative).</p><p>Má»™t Ä‘iá»ƒm thÃº vá»‹ nÃ y, ta cÃ³ thá»ƒ káº¿t há»£p 2 phÆ°Æ¡ng phÃ¡p nÃ y vá»›i nhau. ThÃ´ng qua LLM, ta cÃ³ thá»ƒ tÃ¬m ra má»™t prior belief mang tÃ­nh Ä‘á»‹nh tÃ­nh vÃ  dÃ¹ng nÃ³ Ä‘á»ƒ báº¯t Ä‘áº§u quÃ¡ trÃ¬nh tá»‘i Æ°u hoÃ¡ Ä‘á»‹nh lÆ°á»£ng hÆ¡n (bayesian style).</p><p>BÃ i viáº¿t sau sáº½ tiáº¿n hÃ nh so sÃ¡nh cÃ¡c phÆ°Æ¡ng phÃ¡p truyá»n thá»‘ng vá»›i cÃ¡c phÆ°Æ¡ng phÃ¡p má»›i nÃ y. Äá»ƒ nháº­n file code vÃ  data Ä‘áº§y Ä‘á»§, xin hÃ£y Ä‘á»ƒ comment vÃ o bÃ i viáº¿t trÃªn linkedin hoáº·c gá»­i email Ä‘áº¿n <a href=mailto:hung.ha@miquant.vn>hung.ha@miquant.vn</a>.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/2025/2025-03-03-llm-concept-and-application/><span class=title>Â« BÃ i má»›i hÆ¡n</span><br><span>AI - NgÆ°á»i lÃ m viá»‡c khÃ´ng ngá»«ng nghá»‰</span>
</a><a class=next href=http://localhost:1313/posts/2024/2024-12-02-ai-agent-for-investment/><span class=title>BÃ i cÅ© hÆ¡n Â»</span><br><span>AI Agent: The future of Investment research</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on x" href="https://x.com/intent/tweet/?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&amp;title=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;summary=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&title=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on whatsapp" href="https://api.whatsapp.com/send?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on telegram" href="https://telegram.me/share/url?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tá»‘i Æ°u hoÃ¡ danh má»¥c thÃ´ng qua LLM on ycombinator" href="https://news.ycombinator.com/submitlink?t=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>The Financial Engineer</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Sao chÃ©p";function s(){t.innerHTML="ÄÃ£ sao chÃ©p!",setTimeout(()=>{t.innerHTML="Sao chÃ©p"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>