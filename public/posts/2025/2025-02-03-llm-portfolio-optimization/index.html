<!doctype html><html lang=vi dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tối ưu hoá danh mục thông qua LLM | The Financial Engineer</title>
<meta name=keywords content><meta name=description content="Sử dụng LLM để tối ưu danh mục đầu tư"><meta name=author content><link rel=canonical href=http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=vi href=http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous referrerpolicy=no-referrer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BEV31LZP2J"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BEV31LZP2J")}</script><meta property="og:title" content="Tối ưu hoá danh mục thông qua LLM"><meta property="og:description" content="Sử dụng LLM để tối ưu danh mục đầu tư"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-03T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-03T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tối ưu hoá danh mục thông qua LLM"><meta name=twitter:description content="Sử dụng LLM để tối ưu danh mục đầu tư"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Tối ưu hoá danh mục thông qua LLM","item":"http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tối ưu hoá danh mục thông qua LLM","name":"Tối ưu hoá danh mục thông qua LLM","description":"Sử dụng LLM để tối ưu danh mục đầu tư","keywords":[],"articleBody":" Bài viết này thử nghiệm tối ưu hoá danh mục sử dụng Large Language Model (LLM). Thư viện langchain và OpenAI gpt4o và 4o-mini sẽ được sử dụng cho thử nghiệm.\nConcept Tối ưu hoá danh mục Tối ưu hóa danh mục đầu tư là quá trình phân bổ tài sản vào các khoản đầu tư khác nhau nhằm đạt được sự cân bằng tối ưu giữa lợi nhuận kỳ vọng và rủi ro. Các phương pháp tối ưu hóa truyền thống, như Modern Portfolio Theory hay Mean-variance optimization, chủ yếu dựa vào dữ liệu lịch sử và các giả định về phân phối lợi nhuận. Tuy nhiên, chúng có một số hạn chế:\nKhó khăn trong việc tích hợp các yếu tố định tính: Các phương pháp này thường không xem xét các yếu tố định tính như tin tức thị trường, sự kiện kinh tế hoặc quan điểm của chuyên gia, tiềm năng từ câu chuyện kinh doanh dẫn đến việc thiếu linh hoạt trong phản ứng với các biến động thị trường. Giả định đơn giản hóa: Việc giả định rằng lợi nhuận tuân theo phân phối chuẩn và mối quan hệ giữa các tài sản là tuyến tính có thể không phản ánh chính xác thực tế phức tạp của thị trường. LLM là gì? Mô hình ngôn ngữ lớn (LLM) là các mô hình học sâu được huấn luyện trên khối lượng dữ liệu văn bản khổng lồ, giúp chúng có khả năng hiểu và tạo ra ngôn ngữ tự nhiên. Với khả năng đọc hiểu ngôn ngữ này, LLM có thể trích xuất thông tin và phân tích dữ liệu phi cấu trúc nhanh chóng và đơn giản hơn nhiều so với các phương pháp truyền thống. Ví dụ, LLM có thể đọc 10 bài báo gần đây và tổng hợp ra 3 luận điểm đầu tư phổ biến nhất từ các bài báo đó—một nhiệm vụ mà các phương pháp truyền thống khó thực hiện được.\nTản mạn: một cách khoa học mà nói, chúng ta có thể “hình dung” LLM như sau: LLM là một cỗ máy đưa ra kết quả dựa trên trường hợp có xác suất cao nhất. Các câu prompt đóng vai trò giới hạn phạm vi lựa chọn của LLM, từ đó tăng xác suất cho kết quả mong muốn.\nLLM cho tối ưu hoá danh mục Với khả năng phân tích và tận dụng các dữ liệu phi cấu trúc trên, LLM là một ứng cử viên sáng giá cho quá trình tối ưu hoá danh mục khi có thể tận dụng được: (1) dữ liệu có cấu trúc, thống kê lợi nhuận rủi ro; (2) dữ liệu phi cấu trúc như tiềm năng tăng trưởng công ty, …; (3) đáp ứng được các yêu cầu về mục tiêu đầu tư (objective), hay các rằng buộc đi kèm (constraints) một các nhanh chóng.\nĐể dễ dàng hình dung, chúng ta sẽ cùng nhau đi qua thử nghiệm thực tế cho 6 cổ phiếu FPT, HPG, MWG, REE, VCB và VNM!\nXây dựng danh mục đầu tư sử dụng LLM Quy trình tối ưu sẽ nhau sau\nB1: Xác định rổ cổ phiếu đầu tư B2: Thu thập thông tin: (1) Sentiment của cổ phiếu; (2) Các luận điểm đầu tư - rủi ro của cổ phiếu; (3) tín hiệu kĩ thuật; (4) Độ tương quan giữa các cổ phiếu với nhau B3: Tối ưu hoá danh mục: (1) Các mục tiêu đầu tư cũng như giới hạn cho phép; (2) Xem xét danh mục quá khứ và hiệu suất quý gần nhất. B4: Backtest Thu thập tin tức từ google Tại bước đầu tiên, chúng ta cần xây dựng một pipeline để thu thập được các tin tức liên quan đến từng cổ phiếu, và phải phù hợp với thời gian của giai đoạn backtest. Tại khâu này, chúng ta sẽ sử dụng thư viện langchain để xây dựng pipeline và mô hình gpt-4o-mini để xử lý tin tức\n1 2 3 4 5 6 7 8 9 10 11 def load_google_news_before(query: str, before_date: datetime.date, num_results: int = 30): \"\"\" Query Google News via LangChain’s Google Serper API Wrapper, filtering articles so that only those published before the given date are returned. \"\"\" cd_min = convert_date_to_str(before_date - datetime.timedelta(days=90)) cd_max = convert_date_to_str(before_date) tbs = f\"cdr:1,cd_min:{cd_min},cd_max:{cd_max}\" search = GoogleSerperAPIWrapper(type=\"news\", tbs=tbs, gl=\"vn\",hl='vi',k=num_results) results = search.results(query) return results Ta có thể dễ dàng tạo ra một hàm đọc tin tức sử dụng Serper và thư viện langchain. Hàm trên thiết kế để lấy các tin tức trong vào 90 ngày trước ngày truyền vào.\nTrích xuất các thông tin mong muốn Để thu thập thông tin phục vụ đầu tư, ta tìm kiếm các bài báo với từ khóa “đầu tư vào cổ phiếu ABC”, trong đó ABC là mã cổ phiếu cần phân tích.\nSau khi có được các bài báo liên quan, ta thu thập các thông tin quan trọng bao gồm: (1) sentiment của cổ phiếu trong quý vừa qua; (2) lý giải cho kết quả sentiment đó; (3) các luận điểm đầu tư (Catalyst); (4) các yếu tố rủi ro.\nĐể thực hiện việc này, ta thiết kế câu prompt dựa trên các yêu cầu trên và sử dụng mô hình LLM gpt-4o-mini. Vì nhiệm vụ này chủ yếu là tổng hợp thông tin, không đòi hỏi nhiều suy luận phức tạp, nên việc sử dụng một mô hình nhỏ gọn, nhanh và tiết kiệm như gpt-4o-mini là lựa chọn phù hợp.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ## Sử dụng pydantic để ép model trả về dạng dữ liệu như mong muốn class Sentiment(BaseModel): sentiment: str = Field(default=None, description=\"The financial market sentiment of all news\", enum=[\"bearish\", \"bullish\", \"neutral\"]) explanation: str = Field(default=None, description=\"The short explanation about the chosen sentiment \") catalyst: List[str] = Field(default=None, description=\"The catalyst based on all news\") risk_factor: List[str] = Field(default=None, description=\"The risk factor based on all news\") def extract_key_info(stock , date): \"\"\" Extract key information from a news article. \"\"\" nest_asyncio.apply() query = f\"đầu tư cổ phiếu {stock}\" # For example, retrieve articles published before January 1, 2025. cutoff_date = date articles = load_google_news_before(query, cutoff_date, num_results=15) links = pd.DataFrame(articles['news'])['link'].to_list() ## drop the link from https://etime.danviet.vn links = [link for link in links if 'danviet.vn' not in link] ## skip for danviet.vn as it block the request loader = WebBaseLoader(links, continue_on_failure=True) loader.requests_per_second = 0.5 docs = loader.aload() ls = [] for doc in docs: ls.append(doc.page_content.replace('\\n\\n', '').replace('\\n', ' ')) llm = ChatOpenAI(model='gpt-4o-mini') prompt = \"\"\" You're a senior analyst. You are analyzing stock {stock} Your tasks are: - Analyze the sentiment of the given news - Explain the sentiment in few words - Identify the key catalysts or drivers - Identify the risk factors {document} Requirement - Be specific and concise - Do not make up information or make assumption - Do not use external source \"\"\".format(stock = stock,document=ls) response = llm.with_structured_output(Sentiment).invoke(prompt) return response date = datetime.date(2024, 1, 1) extract_key_info('HPG', date) Kết quả của hàm trên sẽ như sau:\nSentiment(sentiment=‘bearish’, explanation=‘Sentiment is bearish due to significant losses reported by HPG and related companies, along with ongoing challenges in the steel market.’, catalyst=[‘Increased production and sales in October 2023’, ‘Expected recovery in demand and prices for steel’, ‘Completion of Dung Quất 2 project may increase capacity’], risk_factor=[‘High competition in the steel industry’, ‘Dependence on domestic market recovery’, ‘Fluctuations in raw material prices’])\nTối ưu hoá danh mục Khi tối ưu hoá danh mục, việc xây dựng câu prompt chi tiết và cụ thể sẽ giúp giảm thiểu lỗi và tạo ra tỷ trọng hợp lý hơn. Do độ phức tạp tại khâu này tăng cao, chúng ta cần sử dụng một mô hình LLM mạnh mẽ hơn. Bài viết chọn sử dụng gpt-4o.\nMục tiêu đầu tư: Phân bổ tỷ trọng cho các cổ phiếu có tiềm năng tăng trưởng cao, dựa trên tín hiệu kỹ thuật, sentiment và các luận điểm đầu tư.\nCác rằng buộc:\nLong-only portfolio Không sử dụng margin Hold trong 3 tháng Không cần đầu tư hết 6 cổ phiếu nhưng phải có ít nhất 4 cổ phiếu Ngoài ra, câu prompt cũng bao gồm một workflow (quy trình) để LLM có thể dựa vào đó để đưa ra quyết định phân bổ tỷ trọng\nDựa trên các luận điểm đầu tư để xác định các cổ phiếu tiềm năng Đánh giá sentiment của các cổ phiếu đã chọn Sử dụng tín hiệu kỹ thuật để xác nhận thêm tiềm năng của các cổ phiếu Cuối cùng, sử dụng dữ liệu rủi ro-lợi nhuận của 3 tháng qua để xác định các cổ phiếu được mua quá mức hoặc bị thổi phồng, tránh phân bổ quá nhiều vốn cho chúng. Tuy nhiên, nếu luận điểm đầu tư hứa hẹn, ta vẫn có thể phân bổ tiền cho cổ phiếu đó nếu tin rằng nó có tiềm năng đáng kể Chia tỷ trọng cho từng cổ phiếu dựa trên tiềm năng của các luận điểm đầu tư Phân bổ nhiều tỷ trọng hơn cho các cổ phiếu có luận điểm đầu tư khả thi và tiềm năng cao 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 prompt = \"\"\" Create a portfolio with the following stocks: {stocks} Objective: - Use the technical signal, market sentiment and catalysts to assign weight to each stock for a long-only portfolio - The portfolio aim to invest in the stock with the highest potential return Constraints: - The portfolio should be well diversified - You can invest in each stock with a maximum of 0.5 of the portfolio - You do not need to invest in all stocks, but you must invest in at least 4 stocks. Only select the most promising stocks. - There is no leverage \u0026 short selling - The holding period is 3 months (1 quarter) - The weight should be a float number between 0 and 1 - The sum of all weights should be 1 Workflow: 1. Analyze information first. 2. Based on the catalysts, identify the stocks that are likely to perform well. 3. Assess the sentiment of the news to confirm the potential of the selected stocks. 4. Use the technical signal to further confirm the potential of the stocks. 5. Finally, use the past 3 months' risk-return data to identify overbought or hyped stocks to avoid allocating too much capital to them. However, if the catalyst is highly promising, you may still allocate funds to it if you believe it has significant potential. 6. Assign weights to each stock based on the potential return driven by the catalyst. 7. Allocate more weight to stocks where the catalyst is more likely to occur and has a higher magnitude. 8. Be confident in assigning higher weights to stocks with better catalysts and sentiment. 9. **Think carefully; do not simply split the weights equally.** Technical signal: simple EMA50-200 crossover, 1 for bullish, 0 for bearish {ta_signal} Past 3 risk return {risk_return} News sentiment (0 for bearish, 1 for bullish, 2 for neutral) \u0026 Catalysts {sentiment} Correlation between stocks {correlation} Your previous portfolio {past_portfolios} Your previous return: {last_period_return} Output - A list with weight for every stock. The weight must correspond to the oder {stocks}. For stock that not invest, simple return 0 for the weight - A detailed explanation of the rationale behind the portfolio allocation \"\"\" Sau đó, ta sẽ tính toán các tham số và đưa các thông tin cần thiết vào trong mô hình để mô hình thực hiện và tính toán.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 class PortfolioOptimizationResult(BaseModel): \"\"\" A class to represent the result of portfolio optimization. \"\"\" stock_weight: List[float] = Field( default=None, description=\"A list containing the weight for all stocks in the portfolio.\" ) explanation: str = Field( default=None, description=\"A detailed explanation of the rationale behind the portfolio allocation.\" ) def llm_optimizer(date, stocks = ['FPT', 'HPG', 'MWG', 'REE', 'VCB', 'VNM'], past_portfolios = None, last_period_return = None): results = run_in_parallel(stocks, date) llm = ChatOpenAI(model='gpt-4o') ta_signal = ta_compare[:date].iloc[-1] start_sample = date - datetime.timedelta(days=30*3) ## 3 months sample_rets = rets[start_sample:date] risk_return = ((1+sample_rets).product()-1).to_frame() risk_return.columns = ['past_3m_rets'] risk_return['past_3m_volatility'] = sample_rets.std() risk_return['past_3m_sharpe_ratio'] = sample_rets.mean()/risk_return['past_3m_volatility'] risk_return = risk_return.round(4) correlation = sample_rets.corr().round(4) chatprompt = prompt.format(ta_signal=ta_signal, sentiment=results, risk_return=risk_return, stocks=stocks, correlation=correlation, past_portfolios=past_portfolios, last_period_return=last_period_return) optimizer = llm.with_structured_output(PortfolioOptimizationResult).invoke(chatprompt) weight = pd.DataFrame(optimizer.stock_weight, index=stocks, columns=['weights']) weight = weight/weight.sum() ## make sure the sum of weight is 1 retionale = optimizer.explanation return weight, retionale weight, expla = llm_optimizer(datetime.date(2024, 6, 1)) ## this takes around 35 seconds Sau khi chạy hàm trên, ta sẽ nhận được kết quả như sau (danh mục cho tháng 6.2024):\nTỷ trọng danh mục\nweights FPT 0.25 HPG 0.2 MWG 0.3 REE 0.15 VCB 0.1 VNM 0.0 Lý do cho tỷ trọng trên\nIn constructing this portfolio, we focused on stocks with strong bullish technical signals and favorable market sentiment, while considering catalysts and risks.\nFPT (Weight: 0.25): FPT has a bullish technical signal, strong sentiment driven by its partnership with NVIDIA for AI development, and projected revenue growth. Although its valuation is high, its catalysts are promising, warranting a significant allocation. HPG (Weight: 0.2): HPG also exhibits a bullish technical signal and optimistic market sentiment due to strong Q1 financial results and upcoming projects like Dung Quất 2. Despite high debt levels, its growth potential justifies a substantial allocation. MWG (Weight: 0.3): MWG has demonstrated strong past returns and a bullish sentiment, supported by strategic investments and projected growth. The high weight reflects its potential for recovery and profit, despite some risks. REE (Weight: 0.15): REE’s neutral sentiment and mixed outlook are balanced by its dividend plans and growth in renewable energy. Its lower weight reflects these uncertainties, but its diversification benefits and potential in energy justify inclusion. VCB (Weight: 0.1): Despite a neutral sentiment and recent negative returns, VCB’s catalysts such as planned capital increases and potential equity sales offer upside potential, meriting a smaller allocation. VNM (Weight: 0): VNM is excluded due to bearish sentiment and negative past performance, with significant foreign sell-offs and declining market position, making it less attractive for the portfolio. Overall, this portfolio is designed to be diversified and capitalize on stocks with strong potential returns driven by clear catalysts, while mitigating risks associated with each stock’s market position and sentiment.\nBacktest cho phương pháp trên Ta tiến hành xây dựng mô hình backtest đơn giản.\nMua danh mục vào đầu mỗi quý Bỏ qua các yếu tố như phí giao dịch, market impact 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 ## backtest the strategy - \u003e=35s for 1 loop -\u003e 4 years = 4*4*35s \u003e= 560s ~ 9.3 minutes ## create a function that takes the weights and returns the portfolio returns def backtest_strategy(weights, returns): \"\"\" Backtest the strategy \"\"\" port_rets = returns @ weights port_rets.rename(columns={'weights':'rets'}, inplace=True) return port_rets date_idx = pd.date_range('2020-12-31', '2024-12-31', freq='QE') llm_rets = pd.DataFrame() llm_retionale = {} llm_weights = {} for date in date_idx[:-1]: i = 0 start_sample = date - pd.DateOffset(years=3) end_sample = date start_out_sample = date+ pd.DateOffset(days=1) end_out_sample = date + pd.DateOffset(months=3) ## data for the sample period sample_data = rets[start_sample:end_sample] out_sample = rets[start_out_sample:end_out_sample] # run the optimizer if i \u003e=1: past_port = pd.DataFrame(llm_weights[previous_date.strftime(\"%Y-%m-%d\")]) w, explanation = llm_optimizer(date, past_portfolios=past_port, last_period_return= past_return) else: w, explanation = llm_optimizer(date) llm_retionale[date.strftime(\"%Y-%m-%d\")] = explanation llm_weights[date.strftime(\"%Y-%m-%d\")] = w.to_dict()[\"weights\"] # run the backtest llm_backtest = backtest_strategy(w, out_sample) llm_rets = pd.concat([llm_rets, llm_backtest], axis=0) i+=1 previous_date = date past_return = (1+llm_backtest).product()-1 Từ đó, ta thu được kết quả sau:\nLợi nhuận danh mục từ 2021 tới nay\nThống kê liên quan\nLLM VNINDEX Lợi nhuận tích luỹ 70.9% 12.6% Lợi nhuận trung bình hàng năm 14.52% 3.04% Độ biến động trung bình hằng năm 21.66% 19.6% Sharpe ratio 0.73 0.25 Lần sụt giảm mạnh nhất 24.19% 40.34% Chiến lược sử dụng LLM cho kết quả tương đối tốt với lợi nhuận tích luỹ 70.9% so với 12.6% của vnindex qua 4 năm. Tuy nhiên, tỷ lệ sharpe thì tương đối khiêm tốn chỉ 0.73 với độ biến động 21.6%. Ngoài ra lần sụt giảm lớn nhất đạt 24.19% là một kết quả chấp nhận được trong đầu tư.\nDanh mục qua từng giai đoạn\nKết luận Bài viết đã tiến hành xây dựng tối ưu hoá danh mục sử dụng LLM. Thông qua LLM, ta có thể đưa các dữ liệu phi cấu trúc (unstructured-data) vào trong quá trình tối ưu. Đây là một điểm thú vị và các phương pháp truyền thống tận dụng các tính chất thống kê chưa đưa vào được. Tuy nhiên, phải nhấn mạnh lại rằng, tối ưu danh mục theo phương pháp này thì mang nặng yếu tố định tính (qualitative) hơn so với định lượng (quantitative).\nMột điểm thú vị này, ta có thể kết hợp 2 phương pháp này với nhau. Thông qua LLM, ta có thể tìm ra một prior belief mang tính định tính và dùng nó để bắt đầu quá trình tối ưu hoá định lượng hơn (bayesian style).\nBài viết sau sẽ tiến hành so sánh các phương pháp truyền thống với các phương pháp mới này. Để nhận file code và data đầy đủ, xin hãy để comment vào bài viết trên linkedin hoặc gửi email đến hung.ha@miquant.vn.\n","wordCount":"3016","inLanguage":"vi","datePublished":"2025-02-03T00:00:00Z","dateModified":"2025-02-03T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2025/2025-02-03-llm-portfolio-optimization/"},"publisher":{"@type":"Organization","name":"The Financial Engineer","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="The Financial Engineer (Alt + H)">The Financial Engineer</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/about/ title=About><span>About</span></a></li><li><a href=http://localhost:1313/archives/ title=Archive><span>Archive</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Tối ưu hoá danh mục thông qua LLM</h1><div class=post-description>Sử dụng LLM để tối ưu danh mục đầu tư</div><div class=post-meta><span title='2025-02-03 00:00:00 +0000 UTC'>tháng 2 3, 2025</span>&nbsp;·&nbsp;15 phút</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Mục lục</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#concept>Concept</a><ul><li><a href=#tối-ưu-hoá-danh-mục>Tối ưu hoá danh mục</a></li><li><a href=#llm-là-gì>LLM là gì?</a></li><li><a href=#llm-cho-tối-ưu-hoá-danh-mục>LLM cho tối ưu hoá danh mục</a></li></ul></li><li><a href=#xây-dựng-danh-mục-đầu-tư-sử-dụng-llm>Xây dựng danh mục đầu tư sử dụng LLM</a><ul><li><a href=#thu-thập-tin-tức-từ-google>Thu thập tin tức từ google</a></li><li><a href=#trích-xuất-các-thông-tin-mong-muốn>Trích xuất các thông tin mong muốn</a></li><li><a href=#tối-ưu-hoá-danh-mục-1>Tối ưu hoá danh mục</a></li><li><a href=#backtest-cho-phương-pháp-trên>Backtest cho phương pháp trên</a></li></ul></li><li><a href=#kết-luận>Kết luận</a></li></ul></nav></div></details></div><div class=post-content><p><img loading=lazy src=images/1.png#center alt=1.png></p><p>Bài viết này thử nghiệm tối ưu hoá danh mục sử dụng Large Language Model (LLM). Thư viện langchain và OpenAI gpt4o và 4o-mini sẽ được sử dụng cho thử nghiệm.</p><h2 id=concept>Concept<a hidden class=anchor aria-hidden=true href=#concept>#</a></h2><h3 id=tối-ưu-hoá-danh-mục>Tối ưu hoá danh mục<a hidden class=anchor aria-hidden=true href=#tối-ưu-hoá-danh-mục>#</a></h3><p>Tối ưu hóa danh mục đầu tư là quá trình phân bổ tài sản vào các khoản đầu tư khác nhau nhằm đạt được sự cân bằng tối ưu giữa lợi nhuận kỳ vọng và rủi ro. Các phương pháp tối ưu hóa truyền thống, như Modern Portfolio Theory hay Mean-variance optimization, chủ yếu dựa vào dữ liệu lịch sử và các giả định về phân phối lợi nhuận. Tuy nhiên, chúng có một số hạn chế:</p><ul><li><strong>Khó khăn trong việc tích hợp các yếu tố định tính</strong>: Các phương pháp này thường không xem xét các yếu tố định tính như tin tức thị trường, sự kiện kinh tế hoặc quan điểm của chuyên gia, tiềm năng từ câu chuyện kinh doanh dẫn đến việc thiếu linh hoạt trong phản ứng với các biến động thị trường.</li><li><strong>Giả định đơn giản hóa</strong>: Việc giả định rằng lợi nhuận tuân theo phân phối chuẩn và mối quan hệ giữa các tài sản là tuyến tính có thể không phản ánh chính xác thực tế phức tạp của thị trường.</li></ul><h3 id=llm-là-gì>LLM là gì?<a hidden class=anchor aria-hidden=true href=#llm-là-gì>#</a></h3><p>Mô hình ngôn ngữ lớn (LLM) là các mô hình học sâu được huấn luyện trên khối lượng dữ liệu văn bản khổng lồ, giúp chúng có khả năng hiểu và tạo ra ngôn ngữ tự nhiên. Với khả năng đọc hiểu ngôn ngữ này, LLM có thể trích xuất thông tin và phân tích dữ liệu phi cấu trúc nhanh chóng và đơn giản hơn nhiều so với các phương pháp truyền thống. Ví dụ, LLM có thể đọc 10 bài báo gần đây và tổng hợp ra 3 luận điểm đầu tư phổ biến nhất từ các bài báo đó—một nhiệm vụ mà các phương pháp truyền thống khó thực hiện được.</p><p>Tản mạn: một cách khoa học mà nói, chúng ta có thể &ldquo;hình dung&rdquo; LLM như sau: LLM là một cỗ máy đưa ra kết quả dựa trên trường hợp có xác suất cao nhất. Các câu prompt đóng vai trò giới hạn phạm vi lựa chọn của LLM, từ đó tăng xác suất cho kết quả mong muốn.</p><h3 id=llm-cho-tối-ưu-hoá-danh-mục>LLM cho tối ưu hoá danh mục<a hidden class=anchor aria-hidden=true href=#llm-cho-tối-ưu-hoá-danh-mục>#</a></h3><p>Với khả năng phân tích và tận dụng các dữ liệu phi cấu trúc trên, LLM là một ứng cử viên sáng giá cho quá trình tối ưu hoá danh mục khi có thể tận dụng được: (1) dữ liệu có cấu trúc, thống kê lợi nhuận rủi ro; (2) dữ liệu phi cấu trúc như tiềm năng tăng trưởng công ty, …; (3) đáp ứng được các yêu cầu về mục tiêu đầu tư (objective), hay các rằng buộc đi kèm (constraints) một các nhanh chóng.</p><p>Để dễ dàng hình dung, chúng ta sẽ cùng nhau đi qua thử nghiệm thực tế cho 6 cổ phiếu FPT, HPG, MWG, REE, VCB và VNM!</p><h2 id=xây-dựng-danh-mục-đầu-tư-sử-dụng-llm>Xây dựng danh mục đầu tư sử dụng LLM<a hidden class=anchor aria-hidden=true href=#xây-dựng-danh-mục-đầu-tư-sử-dụng-llm>#</a></h2><p>Quy trình tối ưu sẽ nhau sau</p><ul><li>B1: Xác định rổ cổ phiếu đầu tư</li><li>B2: Thu thập thông tin: (1) Sentiment của cổ phiếu; (2) Các luận điểm đầu tư - rủi ro của cổ phiếu; (3) tín hiệu kĩ thuật; (4) Độ tương quan giữa các cổ phiếu với nhau</li><li>B3: Tối ưu hoá danh mục: (1) Các mục tiêu đầu tư cũng như giới hạn cho phép; (2) Xem xét danh mục quá khứ và hiệu suất quý gần nhất.</li><li>B4: Backtest</li></ul><p><img loading=lazy src=images/2.png#center alt=2.png></p><h3 id=thu-thập-tin-tức-từ-google>Thu thập tin tức từ google<a hidden class=anchor aria-hidden=true href=#thu-thập-tin-tức-từ-google>#</a></h3><p>Tại bước đầu tiên, chúng ta cần xây dựng một pipeline để thu thập được các tin tức liên quan đến từng cổ phiếu, và phải phù hợp với thời gian của giai đoạn backtest. Tại khâu này, chúng ta sẽ sử dụng thư viện langchain để xây dựng pipeline và mô hình gpt-4o-mini để xử lý tin tức</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load_google_news_before</span>(query: str, before_date: datetime<span style=color:#f92672>.</span>date, num_results: int <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Query Google News via LangChain’s Google Serper API Wrapper, filtering articles
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    so that only those published before the given date are returned.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    cd_min <span style=color:#f92672>=</span> convert_date_to_str(before_date <span style=color:#f92672>-</span> datetime<span style=color:#f92672>.</span>timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>90</span>))
</span></span><span style=display:flex><span>    cd_max <span style=color:#f92672>=</span> convert_date_to_str(before_date)
</span></span><span style=display:flex><span>    tbs <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;cdr:1,cd_min:</span><span style=color:#e6db74>{</span>cd_min<span style=color:#e6db74>}</span><span style=color:#e6db74>,cd_max:</span><span style=color:#e6db74>{</span>cd_max<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    search <span style=color:#f92672>=</span> GoogleSerperAPIWrapper(type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;news&#34;</span>, tbs<span style=color:#f92672>=</span>tbs, gl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;vn&#34;</span>,hl<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;vi&#39;</span>,k<span style=color:#f92672>=</span>num_results)
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> search<span style=color:#f92672>.</span>results(query)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> results
</span></span></code></pre></td></tr></table></div></div><p>Ta có thể dễ dàng tạo ra một hàm đọc tin tức sử dụng <a href=https://serper.dev>Serper</a> và thư viện langchain. Hàm trên thiết kế để lấy các tin tức trong vào 90 ngày trước ngày truyền vào.</p><h3 id=trích-xuất-các-thông-tin-mong-muốn>Trích xuất các thông tin mong muốn<a hidden class=anchor aria-hidden=true href=#trích-xuất-các-thông-tin-mong-muốn>#</a></h3><p>Để thu thập thông tin phục vụ đầu tư, ta tìm kiếm các bài báo với từ khóa &ldquo;đầu tư vào cổ phiếu ABC&rdquo;, trong đó ABC là mã cổ phiếu cần phân tích.</p><p>Sau khi có được các bài báo liên quan, ta thu thập các thông tin quan trọng bao gồm: (1) sentiment của cổ phiếu trong quý vừa qua; (2) lý giải cho kết quả sentiment đó; (3) các luận điểm đầu tư (Catalyst); (4) các yếu tố rủi ro.</p><p>Để thực hiện việc này, ta thiết kế câu prompt dựa trên các yêu cầu trên và sử dụng mô hình LLM gpt-4o-mini. Vì nhiệm vụ này chủ yếu là tổng hợp thông tin, không đòi hỏi nhiều suy luận phức tạp, nên việc sử dụng một mô hình nhỏ gọn, nhanh và tiết kiệm như gpt-4o-mini là lựa chọn phù hợp.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>## Sử dụng pydantic để ép model trả về dạng dữ liệu như mong muốn</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sentiment</span>(BaseModel):
</span></span><span style=display:flex><span>    sentiment: str <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The financial market sentiment of all news&#34;</span>, enum<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;bearish&#34;</span>, <span style=color:#e6db74>&#34;bullish&#34;</span>, <span style=color:#e6db74>&#34;neutral&#34;</span>])
</span></span><span style=display:flex><span>    explanation: str <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The short explanation about the chosen sentiment &#34;</span>)
</span></span><span style=display:flex><span>    catalyst: List[str] <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The catalyst based on all news&#34;</span>)
</span></span><span style=display:flex><span>    risk_factor: List[str] <span style=color:#f92672>=</span> Field(default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>, description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;The risk factor based on all news&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>extract_key_info</span>(stock , date):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Extract key information from a news article.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    nest_asyncio<span style=color:#f92672>.</span>apply()
</span></span><span style=display:flex><span>    query <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;đầu tư cổ phiếu </span><span style=color:#e6db74>{</span>stock<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># For example, retrieve articles published before January 1, 2025.</span>
</span></span><span style=display:flex><span>    cutoff_date <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    articles <span style=color:#f92672>=</span> load_google_news_before(query, cutoff_date, num_results<span style=color:#f92672>=</span><span style=color:#ae81ff>15</span>)
</span></span><span style=display:flex><span>    links <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(articles[<span style=color:#e6db74>&#39;news&#39;</span>])[<span style=color:#e6db74>&#39;link&#39;</span>]<span style=color:#f92672>.</span>to_list()
</span></span><span style=display:flex><span>    <span style=color:#75715e>## drop the link from https://etime.danviet.vn</span>
</span></span><span style=display:flex><span>    links <span style=color:#f92672>=</span> [link <span style=color:#66d9ef>for</span> link <span style=color:#f92672>in</span> links <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;danviet.vn&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> link] <span style=color:#75715e>## skip for danviet.vn as it block the request</span>
</span></span><span style=display:flex><span>    loader <span style=color:#f92672>=</span> WebBaseLoader(links, continue_on_failure<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    loader<span style=color:#f92672>.</span>requests_per_second <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5</span>
</span></span><span style=display:flex><span>    docs <span style=color:#f92672>=</span> loader<span style=color:#f92672>.</span>aload()
</span></span><span style=display:flex><span>    ls <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> doc <span style=color:#f92672>in</span> docs:
</span></span><span style=display:flex><span>        ls<span style=color:#f92672>.</span>append(doc<span style=color:#f92672>.</span>page_content<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39; &#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    llm <span style=color:#f92672>=</span> ChatOpenAI(model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gpt-4o-mini&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    You&#39;re a senior analyst. You are analyzing stock </span><span style=color:#e6db74>{stock}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Your tasks are: 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Analyze the sentiment of the given news
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Explain the sentiment in few words
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Identify the key catalysts or drivers
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Identify the risk factors
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#e6db74>{document}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Requirement
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Be specific and concise
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Do not make up information or make assumption
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    - Do not use external source
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(stock <span style=color:#f92672>=</span> stock,document<span style=color:#f92672>=</span>ls)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> llm<span style=color:#f92672>.</span>with_structured_output(Sentiment)<span style=color:#f92672>.</span>invoke(prompt)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> response
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>date <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>date(<span style=color:#ae81ff>2024</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>extract_key_info(<span style=color:#e6db74>&#39;HPG&#39;</span>, date)
</span></span></code></pre></td></tr></table></div></div><p>Kết quả của hàm trên sẽ như sau:</p><p>Sentiment(sentiment=&lsquo;bearish&rsquo;, explanation=&lsquo;Sentiment is bearish due to significant losses reported by HPG and related companies, along with ongoing challenges in the steel market.&rsquo;, catalyst=[&lsquo;Increased production and sales in October 2023&rsquo;, &lsquo;Expected recovery in demand and prices for steel&rsquo;, &lsquo;Completion of Dung Quất 2 project may increase capacity&rsquo;], risk_factor=[&lsquo;High competition in the steel industry&rsquo;, &lsquo;Dependence on domestic market recovery&rsquo;, &lsquo;Fluctuations in raw material prices&rsquo;])</p><h3 id=tối-ưu-hoá-danh-mục-1>Tối ưu hoá danh mục<a hidden class=anchor aria-hidden=true href=#tối-ưu-hoá-danh-mục-1>#</a></h3><p>Khi tối ưu hoá danh mục, việc xây dựng câu prompt chi tiết và cụ thể sẽ giúp giảm thiểu lỗi và tạo ra tỷ trọng hợp lý hơn. Do độ phức tạp tại khâu này tăng cao, chúng ta cần sử dụng một mô hình LLM mạnh mẽ hơn. Bài viết chọn sử dụng <strong>gpt-4o.</strong></p><p><strong>Mục tiêu đầu tư</strong>: Phân bổ tỷ trọng cho các cổ phiếu có tiềm năng tăng trưởng cao, dựa trên tín hiệu kỹ thuật, sentiment và các luận điểm đầu tư.</p><p><strong>Các rằng buộc:</strong></p><ul><li>Long-only portfolio</li><li>Không sử dụng margin</li><li>Hold trong 3 tháng</li><li>Không cần đầu tư hết 6 cổ phiếu nhưng phải có ít nhất 4 cổ phiếu</li></ul><p>Ngoài ra, câu prompt cũng bao gồm một workflow (quy trình) để LLM có thể dựa vào đó để đưa ra quyết định phân bổ tỷ trọng</p><ol><li>Dựa trên các luận điểm đầu tư để xác định các cổ phiếu tiềm năng</li><li>Đánh giá sentiment của các cổ phiếu đã chọn</li><li>Sử dụng tín hiệu kỹ thuật để xác nhận thêm tiềm năng của các cổ phiếu</li><li>Cuối cùng, sử dụng dữ liệu rủi ro-lợi nhuận của 3 tháng qua để xác định các cổ phiếu được mua quá mức hoặc bị thổi phồng, tránh phân bổ quá nhiều vốn cho chúng. Tuy nhiên, nếu luận điểm đầu tư hứa hẹn, ta vẫn có thể phân bổ tiền cho cổ phiếu đó nếu tin rằng nó có tiềm năng đáng kể</li><li>Chia tỷ trọng cho từng cổ phiếu dựa trên tiềm năng của các luận điểm đầu tư</li><li>Phân bổ nhiều tỷ trọng hơn cho các cổ phiếu có luận điểm đầu tư khả thi và tiềm năng cao</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>prompt <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Create a portfolio with the following stocks: </span><span style=color:#e6db74>{stocks}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Objective:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- Use the technical signal, market sentiment and catalysts to assign weight to each stock for a long-only portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The portfolio aim to invest in the stock with the highest potential return
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Constraints:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The portfolio should be well diversified
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- You can invest in each stock with a maximum of 0.5 of the portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- You do not need to invest in all stocks, but you must invest in at least 4 stocks. Only select the most promising stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- There is no leverage &amp; short selling
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The holding period is 3 months (1 quarter)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The weight should be a float number between 0 and 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- The sum of all weights should be 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Workflow:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>1. Analyze information first. 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>2. Based on the catalysts, identify the stocks that are likely to perform well.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>3. Assess the sentiment of the news to confirm the potential of the selected stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>4. Use the technical signal to further confirm the potential of the stocks.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>5. Finally, use the past 3 months&#39; risk-return data to identify overbought or hyped stocks to avoid allocating too much capital to them. However, if the catalyst is highly promising, you may still allocate funds to it if you believe it has significant potential.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>6. Assign weights to each stock based on the potential return driven by the catalyst.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>7. Allocate more weight to stocks where the catalyst is more likely to occur and has a higher magnitude.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>8. Be confident in assigning higher weights to stocks with better catalysts and sentiment.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>9. **Think carefully; do not simply split the weights equally.**
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Technical signal: simple EMA50-200 crossover, 1 for bullish, 0 for bearish
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{ta_signal}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Past 3 risk return
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{risk_return}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>News sentiment (0 for bearish, 1 for bullish, 2 for neutral) &amp; Catalysts
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{sentiment}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Correlation between stocks
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{correlation}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Your previous portfolio
</span></span></span><span style=display:flex><span><span style=color:#e6db74></span><span style=color:#e6db74>{past_portfolios}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Your previous return: </span><span style=color:#e6db74>{last_period_return}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Output
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- A list with weight for every stock. The weight must correspond to the oder </span><span style=color:#e6db74>{stocks}</span><span style=color:#e6db74>. For stock that not invest, simple return 0 for the weight
</span></span></span><span style=display:flex><span><span style=color:#e6db74>- A detailed explanation of the rationale behind the portfolio allocation
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau đó, ta sẽ tính toán các tham số và đưa các thông tin cần thiết vào trong mô hình để mô hình thực hiện và tính toán.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PortfolioOptimizationResult</span>(BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    A class to represent the result of portfolio optimization.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    stock_weight: List[float] <span style=color:#f92672>=</span> Field(
</span></span><span style=display:flex><span>        default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A list containing the weight for all stocks in the portfolio.&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    explanation: str <span style=color:#f92672>=</span> Field(
</span></span><span style=display:flex><span>        default<span style=color:#f92672>=</span><span style=color:#66d9ef>None</span>,
</span></span><span style=display:flex><span>        description<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;A detailed explanation of the rationale behind the portfolio allocation.&#34;</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>llm_optimizer</span>(date, stocks <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;FPT&#39;</span>, <span style=color:#e6db74>&#39;HPG&#39;</span>, <span style=color:#e6db74>&#39;MWG&#39;</span>, <span style=color:#e6db74>&#39;REE&#39;</span>, <span style=color:#e6db74>&#39;VCB&#39;</span>, <span style=color:#e6db74>&#39;VNM&#39;</span>], past_portfolios <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>, last_period_return <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>):
</span></span><span style=display:flex><span>    results <span style=color:#f92672>=</span> run_in_parallel(stocks, date)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    llm <span style=color:#f92672>=</span> ChatOpenAI(model<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;gpt-4o&#39;</span>)
</span></span><span style=display:flex><span>    ta_signal <span style=color:#f92672>=</span> ta_compare[:date]<span style=color:#f92672>.</span>iloc[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    start_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>-</span> datetime<span style=color:#f92672>.</span>timedelta(days<span style=color:#f92672>=</span><span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#ae81ff>3</span>) <span style=color:#75715e>## 3 months</span>
</span></span><span style=display:flex><span>    sample_rets <span style=color:#f92672>=</span> rets[start_sample:date]
</span></span><span style=display:flex><span>    risk_return <span style=color:#f92672>=</span> ((<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span>sample_rets)<span style=color:#f92672>.</span>product()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>to_frame()
</span></span><span style=display:flex><span>    risk_return<span style=color:#f92672>.</span>columns <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;past_3m_rets&#39;</span>]
</span></span><span style=display:flex><span>    risk_return[<span style=color:#e6db74>&#39;past_3m_volatility&#39;</span>] <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>std()
</span></span><span style=display:flex><span>    risk_return[<span style=color:#e6db74>&#39;past_3m_sharpe_ratio&#39;</span>] <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>mean()<span style=color:#f92672>/</span>risk_return[<span style=color:#e6db74>&#39;past_3m_volatility&#39;</span>]
</span></span><span style=display:flex><span>    risk_return <span style=color:#f92672>=</span> risk_return<span style=color:#f92672>.</span>round(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    correlation <span style=color:#f92672>=</span> sample_rets<span style=color:#f92672>.</span>corr()<span style=color:#f92672>.</span>round(<span style=color:#ae81ff>4</span>)   
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    chatprompt <span style=color:#f92672>=</span> prompt<span style=color:#f92672>.</span>format(ta_signal<span style=color:#f92672>=</span>ta_signal, sentiment<span style=color:#f92672>=</span>results, risk_return<span style=color:#f92672>=</span>risk_return, stocks<span style=color:#f92672>=</span>stocks, correlation<span style=color:#f92672>=</span>correlation, past_portfolios<span style=color:#f92672>=</span>past_portfolios, last_period_return<span style=color:#f92672>=</span>last_period_return)
</span></span><span style=display:flex><span>    optimizer <span style=color:#f92672>=</span> llm<span style=color:#f92672>.</span>with_structured_output(PortfolioOptimizationResult)<span style=color:#f92672>.</span>invoke(chatprompt)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    weight <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(optimizer<span style=color:#f92672>.</span>stock_weight, index<span style=color:#f92672>=</span>stocks, columns<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;weights&#39;</span>])
</span></span><span style=display:flex><span>    weight <span style=color:#f92672>=</span> weight<span style=color:#f92672>/</span>weight<span style=color:#f92672>.</span>sum() <span style=color:#75715e>## make sure the sum of weight is 1</span>
</span></span><span style=display:flex><span>    retionale <span style=color:#f92672>=</span> optimizer<span style=color:#f92672>.</span>explanation
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> weight, retionale
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>weight, expla <span style=color:#f92672>=</span> llm_optimizer(datetime<span style=color:#f92672>.</span>date(<span style=color:#ae81ff>2024</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>)) <span style=color:#75715e>## this takes around 35 seconds</span>
</span></span></code></pre></td></tr></table></div></div><p>Sau khi chạy hàm trên, ta sẽ nhận được kết quả như sau (danh mục cho tháng 6.2024):</p><p>Tỷ trọng danh mục</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left>weights</th></tr></thead><tbody><tr><td style=text-align:left>FPT</td><td style=text-align:left>0.25</td></tr><tr><td style=text-align:left>HPG</td><td style=text-align:left>0.2</td></tr><tr><td style=text-align:left>MWG</td><td style=text-align:left>0.3</td></tr><tr><td style=text-align:left>REE</td><td style=text-align:left>0.15</td></tr><tr><td style=text-align:left>VCB</td><td style=text-align:left>0.1</td></tr><tr><td style=text-align:left>VNM</td><td style=text-align:left>0.0</td></tr></tbody></table><p>Lý do cho tỷ trọng trên</p><p>In constructing this portfolio, we focused on stocks with strong bullish technical signals and favorable market sentiment, while considering catalysts and risks.</p><ol><li><strong>FPT (Weight: 0.25)</strong>: FPT has a bullish technical signal, strong sentiment driven by its partnership with NVIDIA for AI development, and projected revenue growth. Although its valuation is high, its catalysts are promising, warranting a significant allocation.</li><li><strong>HPG (Weight: 0.2)</strong>: HPG also exhibits a bullish technical signal and optimistic market sentiment due to strong Q1 financial results and upcoming projects like Dung Quất 2. Despite high debt levels, its growth potential justifies a substantial allocation.</li><li><strong>MWG (Weight: 0.3)</strong>: MWG has demonstrated strong past returns and a bullish sentiment, supported by strategic investments and projected growth. The high weight reflects its potential for recovery and profit, despite some risks.</li><li><strong>REE (Weight: 0.15)</strong>: REE&rsquo;s neutral sentiment and mixed outlook are balanced by its dividend plans and growth in renewable energy. Its lower weight reflects these uncertainties, but its diversification benefits and potential in energy justify inclusion.</li><li><strong>VCB (Weight: 0.1)</strong>: Despite a neutral sentiment and recent negative returns, VCB&rsquo;s catalysts such as planned capital increases and potential equity sales offer upside potential, meriting a smaller allocation.</li><li><strong>VNM (Weight: 0)</strong>: VNM is excluded due to bearish sentiment and negative past performance, with significant foreign sell-offs and declining market position, making it less attractive for the portfolio.</li></ol><p>Overall, this portfolio is designed to be diversified and capitalize on stocks with strong potential returns driven by clear catalysts, while mitigating risks associated with each stock&rsquo;s market position and sentiment.</p><h3 id=backtest-cho-phương-pháp-trên>Backtest cho phương pháp trên<a hidden class=anchor aria-hidden=true href=#backtest-cho-phương-pháp-trên>#</a></h3><p>Ta tiến hành xây dựng mô hình backtest đơn giản.</p><ul><li>Mua danh mục vào đầu mỗi quý</li><li>Bỏ qua các yếu tố như phí giao dịch, market impact</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>## backtest the strategy - &gt;=35s for 1 loop -&gt; 4 years = 4*4*35s &gt;= 560s ~ 9.3 minutes</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## create a function that takes the weights and returns the portfolio returns</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>backtest_strategy</span>(weights, returns):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Backtest the strategy
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    port_rets <span style=color:#f92672>=</span>  returns <span style=color:#f92672>@</span> weights
</span></span><span style=display:flex><span>    port_rets<span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;weights&#39;</span>:<span style=color:#e6db74>&#39;rets&#39;</span>}, inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> port_rets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>date_idx <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>date_range(<span style=color:#e6db74>&#39;2020-12-31&#39;</span>, <span style=color:#e6db74>&#39;2024-12-31&#39;</span>, freq<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;QE&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>llm_rets <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame()
</span></span><span style=display:flex><span>llm_retionale <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>llm_weights <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> date <span style=color:#f92672>in</span> date_idx[:<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]:
</span></span><span style=display:flex><span>    i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    start_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>-</span> pd<span style=color:#f92672>.</span>DateOffset(years<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    end_sample <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    start_out_sample <span style=color:#f92672>=</span> date<span style=color:#f92672>+</span> pd<span style=color:#f92672>.</span>DateOffset(days<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    end_out_sample <span style=color:#f92672>=</span> date <span style=color:#f92672>+</span> pd<span style=color:#f92672>.</span>DateOffset(months<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>## data for the sample period</span>
</span></span><span style=display:flex><span>    sample_data <span style=color:#f92672>=</span> rets[start_sample:end_sample]
</span></span><span style=display:flex><span>    out_sample <span style=color:#f92672>=</span> rets[start_out_sample:end_out_sample]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># run the optimizer</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> i <span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>        past_port <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>DataFrame(llm_weights[previous_date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)])
</span></span><span style=display:flex><span>        w, explanation <span style=color:#f92672>=</span> llm_optimizer(date, past_portfolios<span style=color:#f92672>=</span>past_port, last_period_return<span style=color:#f92672>=</span> past_return)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        w, explanation <span style=color:#f92672>=</span> llm_optimizer(date)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    llm_retionale[date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> explanation
</span></span><span style=display:flex><span>    llm_weights[date<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74>&#34;</span>)] <span style=color:#f92672>=</span> w<span style=color:#f92672>.</span>to_dict()[<span style=color:#e6db74>&#34;weights&#34;</span>]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e># run the backtest</span>
</span></span><span style=display:flex><span>    llm_backtest <span style=color:#f92672>=</span> backtest_strategy(w, out_sample)
</span></span><span style=display:flex><span>    llm_rets <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat([llm_rets, llm_backtest], axis<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    i<span style=color:#f92672>+=</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    previous_date <span style=color:#f92672>=</span> date
</span></span><span style=display:flex><span>    past_return <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span><span style=color:#f92672>+</span>llm_backtest)<span style=color:#f92672>.</span>product()<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span></code></pre></td></tr></table></div></div><p>Từ đó, ta thu được kết quả sau:</p><p>Lợi nhuận danh mục từ 2021 tới nay</p><p><img loading=lazy src=images/3.png#center alt=3.png></p><p>Thống kê liên quan</p><table><thead><tr><th style=text-align:left></th><th style=text-align:left><strong>LLM</strong></th><th style=text-align:left><strong>VNINDEX</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>Lợi nhuận tích luỹ</strong></td><td style=text-align:left>70.9%</td><td style=text-align:left>12.6%</td></tr><tr><td style=text-align:left><strong>Lợi nhuận trung bình hàng năm</strong></td><td style=text-align:left>14.52%</td><td style=text-align:left>3.04%</td></tr><tr><td style=text-align:left><strong>Độ biến động trung bình hằng năm</strong></td><td style=text-align:left>21.66%</td><td style=text-align:left>19.6%</td></tr><tr><td style=text-align:left><strong>Sharpe ratio</strong></td><td style=text-align:left>0.73</td><td style=text-align:left>0.25</td></tr><tr><td style=text-align:left><strong>Lần sụt giảm mạnh nhất</strong></td><td style=text-align:left>24.19%</td><td style=text-align:left>40.34%</td></tr></tbody></table><p>Chiến lược sử dụng LLM cho kết quả tương đối tốt với lợi nhuận tích luỹ 70.9% so với 12.6% của vnindex qua 4 năm. Tuy nhiên, tỷ lệ sharpe thì tương đối khiêm tốn chỉ 0.73 với độ biến động 21.6%. Ngoài ra lần sụt giảm lớn nhất đạt 24.19% là một kết quả chấp nhận được trong đầu tư.</p><p>Danh mục qua từng giai đoạn</p><p><img loading=lazy src=images/4.png#center alt=4.png></p><h2 id=kết-luận>Kết luận<a hidden class=anchor aria-hidden=true href=#kết-luận>#</a></h2><p>Bài viết đã tiến hành xây dựng tối ưu hoá danh mục sử dụng LLM. Thông qua LLM, ta có thể đưa các dữ liệu phi cấu trúc (unstructured-data) vào trong quá trình tối ưu. Đây là một điểm thú vị và các phương pháp truyền thống tận dụng các tính chất thống kê chưa đưa vào được. Tuy nhiên, phải nhấn mạnh lại rằng, tối ưu danh mục theo phương pháp này thì mang nặng yếu tố định tính (qualitative) hơn so với định lượng (quantitative).</p><p>Một điểm thú vị này, ta có thể kết hợp 2 phương pháp này với nhau. Thông qua LLM, ta có thể tìm ra một prior belief mang tính định tính và dùng nó để bắt đầu quá trình tối ưu hoá định lượng hơn (bayesian style).</p><p>Bài viết sau sẽ tiến hành so sánh các phương pháp truyền thống với các phương pháp mới này. Để nhận file code và data đầy đủ, xin hãy để comment vào bài viết trên linkedin hoặc gửi email đến <a href=mailto:hung.ha@miquant.vn>hung.ha@miquant.vn</a>.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/2025/2025-03-03-llm-concept-and-application/><span class=title>« Bài mới hơn</span><br><span>AI - Người làm việc không ngừng nghỉ</span>
</a><a class=next href=http://localhost:1313/posts/2024/2024-12-02-ai-agent-for-investment/><span class=title>Bài cũ hơn »</span><br><span>AI Agent: The future of Investment research</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on x" href="https://x.com/intent/tweet/?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&amp;title=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;summary=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f&title=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on whatsapp" href="https://api.whatsapp.com/send?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on telegram" href="https://telegram.me/share/url?text=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Tối ưu hoá danh mục thông qua LLM on ycombinator" href="https://news.ycombinator.com/submitlink?t=T%e1%bb%91i%20%c6%b0u%20ho%c3%a1%20danh%20m%e1%bb%a5c%20th%c3%b4ng%20qua%20LLM&u=http%3a%2f%2flocalhost%3a1313%2fposts%2f2025%2f2025-02-03-llm-portfolio-optimization%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>The Financial Engineer</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="Sao chép";function s(){t.innerHTML="Đã sao chép!",setTimeout(()=>{t.innerHTML="Sao chép"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>